<!DOCTYPE html>  
  
<html lang="es">  
<head>  
<meta charset="UTF-8">  
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">  
<meta name="theme-color" content="#0A0A14">  
<meta name="apple-mobile-web-app-capable" content="yes">  
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">  
<meta name="apple-mobile-web-app-title" content="Hogar">  
<meta name="mobile-web-app-capable" content="yes">  
<meta name="description" content="App de tareas del hogar con puntos y ranking familiar">  
<link rel="manifest" href="manifest.json">  
<link rel="apple-touch-icon" href="icons/icon-192.png">  
<link rel="icon" href="icons/icon-192.png">  
<title>Hogar ✦</title>  
<link rel="preconnect" href="https://fonts.googleapis.com">  
<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;500;600;700;800&family=Instrument+Sans:wght@400;500;600&display=swap" rel="stylesheet">  
  
<style>  
/* ═══════════════════════════════════════════  
   DESIGN TOKENS  
═══════════════════════════════════════════ */  
:root {  
  --bg:       #0A0A14;  
  --bg2:      #12121F;  
  --surface:  #1A1A2E;  
  --surface2: #22223A;  
  --border:   rgba(255,255,255,0.07);  
  --border2:  rgba(255,255,255,0.12);  
  
  --neon:     #7DF9FF;  
  --neon2:    #A78BFA;  
  --green:    #34EE9A;  
  --amber:    #FFC453;  
  --rose:     #FF6B8A;  
  --blue:     #60A5FA;  
  
  --text:     #F1F5FF;  
  --text2:    #8892B0;  
  --text3:    #4A5066;  
  
  --r-lg:     22px;  
  --r-md:     14px;  
  --r-sm:     10px;  
  
  --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);  
  --ease-out:    cubic-bezier(0.16, 1, 0.3, 1);  
}  
  
/* ═══════════════════════════════════════════  
   RESET & BASE  
═══════════════════════════════════════════ */  
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }  
  
html { height: 100%; overscroll-behavior: none; }  
  
body {  
  font-family: 'Instrument Sans', sans-serif;  
  background: var(--bg);  
  color: var(--text);  
  min-height: 100%;  
  max-width: 430px;  
  margin: 0 auto;  
  overflow-x: hidden;  
  position: relative;  
  -webkit-font-smoothing: antialiased;  
}  
  
h1,h2,h3,h4,.score,.pts-big { font-family: 'Bricolage Grotesque', sans-serif; }  
  
/* ═══════════════════════════════════════════  
   AMBIENT BACKGROUND GLOW  
═══════════════════════════════════════════ */  
.bg-glow {  
  position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden;  
}  
.glow-1 {  
  position: absolute; width: 400px; height: 400px;  
  background: radial-gradient(circle, rgba(125,249,255,0.06) 0%, transparent 70%);  
  top: -100px; left: -100px; animation: driftGlow 8s ease-in-out infinite;  
}  
.glow-2 {  
  position: absolute; width: 350px; height: 350px;  
  background: radial-gradient(circle, rgba(167,139,250,0.05) 0%, transparent 70%);  
  bottom: 100px; right: -80px; animation: driftGlow 10s ease-in-out infinite reverse;  
}  
@keyframes driftGlow {  
  0%,100% { transform: translate(0,0) scale(1); }  
  50% { transform: translate(30px,20px) scale(1.1); }  
}  
  
/* ═══════════════════════════════════════════  
   APP SHELL  
═══════════════════════════════════════════ */  
#app { position: relative; z-index: 1; padding-bottom: 96px; min-height: 100vh; }  
  
/* ═══════════════════════════════════════════  
   AUTH / ONBOARDING  
═══════════════════════════════════════════ */  
#authScreen {  
  position: fixed; inset: 0; z-index: 500;  
  background: var(--bg);  
  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  padding: max(env(safe-area-inset-top), 32px) 32px max(env(safe-area-inset-bottom), 32px);
  overflow-y: auto;
  transition: opacity 0.5s var(--ease-out), transform 0.5s var(--ease-out);  
}  
#authScreen.hidden { opacity: 0; transform: scale(0.96); pointer-events: none; }

.auth-header {
  display: flex; flex-direction: column; align-items: center;
  padding-top: 24px; padding-bottom: 8px; width: 100%;
}  
  
.auth-logo {  
  font-size: 72px; margin-bottom: 24px;  
  animation: floatLogo 3s ease-in-out infinite;  
  filter: drop-shadow(0 0 20px rgba(125,249,255,0.4));  
}  
@keyframes floatLogo {  
  0%,100% { transform: translateY(0) rotate(-3deg); }  
  50% { transform: translateY(-12px) rotate(3deg); }  
}  
.auth-title {  
  font-size: 38px; font-weight: 800; text-align: center; line-height: 1.1;  
  background: linear-gradient(135deg, var(--neon), var(--neon2));  
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;  
  margin-bottom: 8px;  
}  
.auth-sub { color: var(--text2); font-size: 15px; text-align: center; margin-bottom: 48px; }  
  
.auth-step { width: 100%; display: none; animation: slideInAuth 0.4s var(--ease-spring); }  
.auth-step.active { display: block; }  
@keyframes slideInAuth {  
  from { opacity: 0; transform: translateX(20px); }  
  to { opacity: 1; transform: translateX(0); }  
}  
  
.auth-label { font-size: 13px; font-weight: 600; color: var(--text2); letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 8px; }  
.auth-input {  
  width: 100%; padding: 16px 18px;  
  background: var(--surface); border: 1.5px solid var(--border2);  
  border-radius: var(--r-md); color: var(--text);  
  font-family: 'Instrument Sans', sans-serif; font-size: 16px;  
  outline: none; transition: border-color 0.2s, box-shadow 0.2s;  
  margin-bottom: 12px;  
}  
.auth-input:focus { border-color: var(--neon); box-shadow: 0 0 0 3px rgba(125,249,255,0.1); }  
  
.avatar-pick { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 24px; justify-content: center; }  
.avatar-opt {  
  width: 56px; height: 56px; border-radius: 50%;  
  background: var(--surface); border: 2px solid var(--border2);  
  font-size: 28px; display: flex; align-items: center; justify-content: center;  
  cursor: pointer; transition: all 0.2s var(--ease-spring);  
}  
.avatar-opt.sel {  
  border-color: var(--neon); background: rgba(125,249,255,0.1);  
  transform: scale(1.12); box-shadow: 0 0 16px rgba(125,249,255,0.3);  
}  
.avatar-opt:active { transform: scale(0.9); }  
  
.code-input {  
  width: 100%; padding: 16px 18px;  
  background: var(--surface); border: 1.5px solid var(--border2);  
  border-radius: var(--r-md); color: var(--text);  
  font-family: 'Bricolage Grotesque', sans-serif; font-size: 28px;  
  letter-spacing: 8px; text-align: center;  
  outline: none; transition: border-color 0.2s;  
  margin-bottom: 12px; text-transform: uppercase;  
}  
.code-input:focus { border-color: var(--neon); }  
  
.code-display {  
  text-align: center; margin-bottom: 8px;  
}  
.code-big {  
  font-size: 52px; font-weight: 800; letter-spacing: 10px;  
  background: linear-gradient(135deg, var(--neon), var(--green));  
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;  
  font-family: 'Bricolage Grotesque', sans-serif;  
}  
.code-hint { color: var(--text2); font-size: 13px; margin-bottom: 24px; text-align: center; }  
  
.btn-glow {  
  width: 100%; padding: 17px;  
  background: linear-gradient(135deg, var(--neon), var(--neon2));  
  border: none; border-radius: var(--r-md);  
  font-family: 'Bricolage Grotesque', sans-serif; font-size: 16px; font-weight: 700;  
  color: #0A0A14; cursor: pointer;  
  transition: all 0.2s var(--ease-spring);  
  box-shadow: 0 4px 24px rgba(125,249,255,0.3);  
  letter-spacing: 0.3px;  
}  
.btn-glow:active { transform: scale(0.97); box-shadow: 0 2px 12px rgba(125,249,255,0.2); }  
.btn-glow:disabled { opacity: 0.4; cursor: default; }  
  
.btn-ghost {  
  width: 100%; padding: 14px;  
  background: transparent; border: 1.5px solid var(--border2);  
  border-radius: var(--r-md); color: var(--text2);  
  font-family: 'Instrument Sans', sans-serif; font-size: 15px; font-weight: 500;  
  cursor: pointer; transition: all 0.2s; margin-top: 10px;  
}  
.btn-ghost:active { background: var(--surface); }  
  
/* ═══════════════════════════════════════════  
   BOTTOM NAV  
═══════════════════════════════════════════ */  
.nav {  
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);  
  width: 100%; max-width: 430px;  
  background: rgba(10,10,20,0.85);  
  backdrop-filter: blur(24px) saturate(180%);  
  -webkit-backdrop-filter: blur(24px) saturate(180%);  
  border-top: 1px solid var(--border);  
  display: flex; align-items: center; justify-content: space-around;  
  padding: 10px 0 max(16px, env(safe-area-inset-bottom));  
  z-index: 100;  
}  
.nav-item {  
  display: flex; flex-direction: column; align-items: center; gap: 4px;  
  cursor: pointer; padding: 6px 20px; border-radius: 16px;  
  transition: all 0.3s var(--ease-spring); position: relative;  
  min-width: 60px;  
}  
.nav-icon { font-size: 22px; transition: transform 0.3s var(--ease-spring), filter 0.3s; }  
.nav-label { font-size: 10px; font-weight: 600; color: var(--text3); transition: color 0.3s; letter-spacing: 0.3px; }  
.nav-item.active .nav-icon { transform: translateY(-3px) scale(1.15); filter: drop-shadow(0 0 8px var(--neon)); }  
.nav-item.active .nav-label { color: var(--neon); }  
.nav-indicator {  
  position: absolute; bottom: -6px; width: 4px; height: 4px;  
  background: var(--neon); border-radius: 50%; opacity: 0;  
  transition: opacity 0.3s, transform 0.3s;  
  box-shadow: 0 0 6px var(--neon);  
}  
.nav-item.active .nav-indicator { opacity: 1; }  
.nav-item:active { transform: scale(0.9); }  
  
/* ═══════════════════════════════════════════  
   SCREENS  
═══════════════════════════════════════════ */  
.screen { display: none; }  
.screen.active {  
  display: block;  
  animation: screenIn 0.45s var(--ease-out);  
}  
@keyframes screenIn {  
  from { opacity: 0; transform: translateY(10px); }  
  to   { opacity: 1; transform: translateY(0); }  
}  
  
/* ═══════════════════════════════════════════  
   HOME HEADER  
═══════════════════════════════════════════ */  
.home-header {  
  padding: calc(env(safe-area-inset-top) + 48px) 22px 0;  
  position: relative;  
}  
.home-top { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 22px; }  
.home-greeting { font-size: 13px; color: var(--text2); margin-bottom: 4px; letter-spacing: 0.3px; }  
.home-name { font-size: 26px; font-weight: 800; line-height: 1.1; }  
.home-name span { background: linear-gradient(90deg, var(--neon), var(--blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }  
  
.avatar-pill {  
  display: flex; align-items: center; gap: 8px;  
  background: var(--surface); border: 1px solid var(--border2);  
  border-radius: 30px; padding: 6px 12px 6px 6px;  
  cursor: pointer; transition: all 0.2s var(--ease-spring);  
}  
.avatar-pill:active { transform: scale(0.95); }  
.avatar-pill-icon { width: 36px; height: 36px; border-radius: 50%; background: var(--surface2); font-size: 20px; display: flex; align-items: center; justify-content: center; }  
.avatar-pill-pts { font-size: 13px; font-weight: 700; color: var(--amber); font-family: 'Bricolage Grotesque', sans-serif; }  
  
/* Hero card */  
.hero-card {  
  background: linear-gradient(135deg, #1A1A35 0%, #0F1628 100%);  
  border: 1px solid var(--border2); border-radius: var(--r-lg);  
  padding: 20px; margin-bottom: 20px; position: relative; overflow: hidden;  
}  
.hero-card::before {  
  content: ''; position: absolute; inset: 0;  
  background: linear-gradient(135deg, rgba(125,249,255,0.05), rgba(167,139,250,0.05));  
  pointer-events: none;  
}  
.hero-grid { display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: center; }  
.hero-pts-label { font-size: 12px; color: var(--text2); margin-bottom: 4px; }  
.hero-pts { font-size: 48px; font-weight: 800; line-height: 1; background: linear-gradient(90deg, var(--amber), var(--rose)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }  
.hero-pts-sub { font-size: 12px; color: var(--text2); margin-top: 4px; }  
.hero-streak {  
  display: inline-flex; align-items: center; gap: 5px;  
  background: rgba(255,196,83,0.12); border: 1px solid rgba(255,196,83,0.25);  
  border-radius: 20px; padding: 4px 10px;  
  font-size: 12px; font-weight: 600; color: var(--amber); margin-top: 10px;  
}  
  
/* Donut chart */  
.donut-wrap { position: relative; width: 80px; height: 80px; }  
.donut-svg { transform: rotate(-90deg); }  
.donut-bg { fill: none; stroke: rgba(255,255,255,0.06); stroke-width: 7; }  
.donut-fill {  
  fill: none; stroke: url(#donutGrad); stroke-width: 7;  
  stroke-linecap: round;  
  stroke-dasharray: 207;  
  stroke-dashoffset: 207;  
  transition: stroke-dashoffset 1.2s cubic-bezier(0.34,1.56,0.64,1);  
}  
.donut-text {  
  position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);  
  text-align: center;  
}  
.donut-pct { font-size: 18px; font-weight: 800; color: var(--text); font-family: 'Bricolage Grotesque', sans-serif; }  
.donut-lbl { font-size: 9px; color: var(--text3); }  
  
/* Week bar */  
.week-section { margin-bottom: 20px; }  
.week-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }  
.week-title { font-size: 12px; color: var(--text2); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }  
.week-val { font-size: 12px; font-weight: 700; color: var(--neon); }  
.week-track {  
  height: 6px; background: var(--surface2); border-radius: 3px; overflow: visible; position: relative;  
}  
.week-fill {  
  height: 100%; background: linear-gradient(90deg, var(--neon), var(--blue));  
  border-radius: 3px; transition: width 1.2s cubic-bezier(0.34,1.56,0.64,1);  
  position: relative;  
}  
.week-fill::after {  
  content: '';  
  position: absolute; right: -1px; top: 50%; transform: translateY(-50%);  
  width: 10px; height: 10px; border-radius: 50%;  
  background: var(--neon); box-shadow: 0 0 10px var(--neon);  
  transition: opacity 0.5s;  
}  
  
/* ═══════════════════════════════════════════  
   USER SWITCHER (horizontal scroll)  
═══════════════════════════════════════════ */  
.users-scroll {  
  display: flex; gap: 10px; overflow-x: auto; padding: 0 22px 18px;  
  scrollbar-width: none; scroll-snap-type: x mandatory;  
}  
.users-scroll::-webkit-scrollbar { display: none; }  
.user-chip {  
  display: flex; align-items: center; gap: 8px;  
  background: var(--surface); border: 1.5px solid var(--border);  
  border-radius: 30px; padding: 7px 14px 7px 7px;  
  cursor: pointer; transition: all 0.25s var(--ease-spring);  
  white-space: nowrap; scroll-snap-align: start; flex-shrink: 0;  
}  
.user-chip.active {  
  border-color: var(--neon); background: rgba(125,249,255,0.08);  
  box-shadow: 0 0 16px rgba(125,249,255,0.15);  
}  
.user-chip:active { transform: scale(0.93); }  
.uc-avatar { width: 30px; height: 30px; border-radius: 50%; background: var(--surface2); font-size: 16px; display: flex; align-items: center; justify-content: center; }  
.uc-name { font-size: 13px; font-weight: 600; color: var(--text2); }  
.user-chip.active .uc-name { color: var(--neon); }  
.uc-pts { font-size: 11px; color: var(--text3); }  
.user-chip.active .uc-pts { color: rgba(125,249,255,0.7); }  
  
/* ═══════════════════════════════════════════  
   FILTER CHIPS  
═══════════════════════════════════════════ */  
.filters { display: flex; gap: 8px; overflow-x: auto; padding: 0 22px 16px; scrollbar-width: none; }  
.filters::-webkit-scrollbar { display: none; }  
.chip {  
  padding: 7px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;  
  white-space: nowrap; cursor: pointer;  
  background: var(--surface); color: var(--text3);  
  border: 1.5px solid var(--border); flex-shrink: 0;  
  transition: all 0.2s var(--ease-spring);  
}  
.chip.active { background: rgba(125,249,255,0.1); color: var(--neon); border-color: rgba(125,249,255,0.4); }  
.chip:active { transform: scale(0.93); }  
  
/* ═══════════════════════════════════════════  
   TASK CARDS  
═══════════════════════════════════════════ */  
.tasks-section { padding: 0 22px; }  
.section-title { font-size: 15px; font-weight: 700; color: var(--text2); margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }  
.sec-add { font-size: 13px; color: var(--neon); cursor: pointer; font-weight: 600; }  
  
.task-card {  
  background: var(--surface); border: 1.5px solid var(--border);  
  border-radius: var(--r-lg); padding: 16px;  
  margin-bottom: 10px; cursor: pointer;  
  display: flex; align-items: center; gap: 14px;  
  transition: all 0.35s var(--ease-spring);  
  position: relative; overflow: hidden;  
  will-change: transform;  
}  
.task-card::before {  
  content: ''; position: absolute; inset: 0;  
  background: linear-gradient(135deg, transparent, rgba(125,249,255,0.03));  
  opacity: 0; transition: opacity 0.3s;  
}  
.task-card:active { transform: scale(0.97); }  
.task-card.done {  
  background: rgba(52,238,154,0.05);  
  border-color: rgba(52,238,154,0.2);  
}  
.task-card.done::before { opacity: 1; background: linear-gradient(135deg, transparent, rgba(52,238,154,0.04)); }  
  
.task-icon-wrap {  
  width: 50px; height: 50px; border-radius: 14px;  
  display: flex; align-items: center; justify-content: center;  
  font-size: 24px; flex-shrink: 0; position: relative;  
  transition: transform 0.3s var(--ease-spring);  
}  
.task-card.done .task-icon-wrap { transform: scale(0.9); }  
.task-icon-glow {  
  position: absolute; inset: 0; border-radius: 14px; opacity: 0;  
  transition: opacity 0.4s; pointer-events: none;  
}  
.task-card.done .task-icon-glow { opacity: 1; }  
  
.task-body { flex: 1; min-width: 0; }  
.task-name {  
  font-size: 15px; font-weight: 600; margin-bottom: 4px;  
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;  
  transition: all 0.3s;  
}  
.task-card.done .task-name { text-decoration: line-through; color: var(--text3); }  
.task-meta { display: flex; align-items: center; gap: 7px; flex-wrap: wrap; }  
.task-pts-badge {  
  background: rgba(125,249,255,0.1); color: var(--neon);  
  border: 1px solid rgba(125,249,255,0.2);  
  border-radius: 20px; padding: 2px 8px; font-size: 11px; font-weight: 700;  
  transition: all 0.3s;  
}  
.task-card.done .task-pts-badge { background: rgba(52,238,154,0.1); color: var(--green); border-color: rgba(52,238,154,0.2); }  
.task-freq { font-size: 11px; color: var(--text3); }  
.task-assignees { display: flex; }  
.t-av {  
  width: 18px; height: 18px; border-radius: 50%; font-size: 10px;  
  background: var(--surface2); border: 1.5px solid var(--bg);  
  display: flex; align-items: center; justify-content: center;  
  margin-left: -4px;  
}  
.t-av:first-child { margin-left: 0; }  
  
/* Checkbox */  
.task-check {  
  width: 32px; height: 32px; border-radius: 50%;  
  border: 2px solid var(--border2); background: transparent;  
  display: flex; align-items: center; justify-content: center;  
  transition: all 0.35s var(--ease-spring); flex-shrink: 0;  
  position: relative; overflow: hidden;  
}  
.task-check::before {  
  content: ''; position: absolute; inset: 0; border-radius: 50%;  
  background: var(--green); transform: scale(0);  
  transition: transform 0.35s var(--ease-spring);  
}  
.task-check.done::before { transform: scale(1); }  
.check-icon {  
  font-size: 14px; position: relative; z-index: 1;  
  transform: scale(0) rotate(-30deg);  
  transition: transform 0.35s var(--ease-spring) 0.1s;  
}  
.task-check.done .check-icon { transform: scale(1) rotate(0deg); }  
  
/* Locked task (not assigned to me) */  
.task-card.locked-card { opacity: 0.7; cursor: default; }  
.task-card.locked-card:active { transform: none; }  
.locked-check {  
  border-color: var(--text3) !important;  
  background: transparent !important;  
  cursor: default;  
}  
.locked-check .check-icon { font-size: 13px !important; transform: scale(1) rotate(0deg) !important; }  
  
/* ═══════════════════════════════════════════  
   TASK COMPLETION ANIMATION  
═══════════════════════════════════════════ */  
  
/* Slide-out + fade when task is completed and filter hides it */  
@keyframes taskCompleteSlideOut {  
  0%   { transform: scale(1) translateX(0); opacity: 1; max-height: 120px; margin-bottom: 10px; }  
  30%  { transform: scale(1.03) translateX(0); opacity: 1; }  
  70%  { transform: scale(0.97) translateX(40px); opacity: 0.4; max-height: 120px; margin-bottom: 10px; }  
  100% { transform: scale(0.9) translateX(60px); opacity: 0; max-height: 0; margin-bottom: 0; padding-top:0; padding-bottom:0; }  
}  
.task-card.completing {  
  animation: taskCompleteSlideOut 0.55s cubic-bezier(0.4, 0, 0.2, 1) forwards;  
  pointer-events: none;  
  overflow: hidden;  
}  
  
/* Glow flash overlay on the card */  
@keyframes cardFlash {  
  0%   { opacity: 0; }  
  25%  { opacity: 1; }  
  100% { opacity: 0; }  
}  
.task-flash {  
  position: absolute; inset: 0; border-radius: inherit;  
  background: linear-gradient(135deg, rgba(52,238,154,0.35), rgba(125,249,255,0.2));  
  pointer-events: none; z-index: 5;  
  animation: cardFlash 0.5s ease forwards;  
}  
  
/* Check button morph */  
@keyframes checkMorph {  
  0%   { transform: scale(1); }  
  40%  { transform: scale(1.35); }  
  65%  { transform: scale(0.9); }  
  100% { transform: scale(1.1); }  
}  
.task-check.completing-check {  
  animation: checkMorph 0.45s var(--ease-spring) forwards;  
}  
  
/* Points float up — completion */  
.pts-float {  
  position: fixed; pointer-events: none; z-index: 998;  
  font-family: 'Bricolage Grotesque', sans-serif;  
  font-size: 22px; font-weight: 800;  
  color: var(--green);  
  text-shadow: 0 0 12px rgba(52,238,154,0.6);  
  animation: ptsFloatUp 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;  
  white-space: nowrap;  
}  
@keyframes ptsFloatUp {  
  0%   { opacity: 0; transform: translateY(0) scale(0.6); }  
  20%  { opacity: 1; transform: translateY(-10px) scale(1.1); }  
  80%  { opacity: 1; transform: translateY(-50px) scale(1); }  
  100% { opacity: 0; transform: translateY(-70px) scale(0.9); }  
}  
  
/* Points float down — uncomplete */  
.pts-float-down {  
  position: fixed; pointer-events: none; z-index: 998;  
  font-family: 'Bricolage Grotesque', sans-serif;  
  font-size: 20px; font-weight: 800;  
  color: var(--rose);  
  text-shadow: 0 0 12px rgba(255,107,138,0.5);  
  animation: ptsFloatDown 0.9s cubic-bezier(0.16, 1, 0.3, 1) forwards;  
  white-space: nowrap;  
}  
@keyframes ptsFloatDown {  
  0%   { opacity: 0; transform: translateY(0) scale(0.6); }  
  20%  { opacity: 1; transform: translateY(8px) scale(1.05); }  
  80%  { opacity: 0.8; transform: translateY(40px) scale(0.95); }  
  100% { opacity: 0; transform: translateY(55px) scale(0.85); }  
}  
  
/* Card shake on uncomplete */  
@keyframes cardShake {  
  0%   { transform: translateX(0) scale(1); }  
  15%  { transform: translateX(-6px) scale(0.98); }  
  35%  { transform: translateX(5px) scale(0.99); }  
  55%  { transform: translateX(-3px) scale(1); }  
  75%  { transform: translateX(2px); }  
  100% { transform: translateX(0); }  
}  
.task-card.uncompleting {  
  animation: cardShake 0.45s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;  
}  
  
/* Red flash overlay on uncomplete */  
@keyframes cardFlashRed {  
  0%   { opacity: 0; }  
  25%  { opacity: 1; }  
  100% { opacity: 0; }  
}  
.task-flash-red {  
  position: absolute; inset: 0; border-radius: inherit;  
  background: linear-gradient(135deg, rgba(255,107,138,0.2), rgba(255,107,138,0.08));  
  pointer-events: none; z-index: 5;  
  animation: cardFlashRed 0.45s ease forwards;  
}  
  
/* ═══════════════════════════════════════════  
   PARTICLE BURST  
═══════════════════════════════════════════ */  
.burst-container { position: fixed; inset: 0; pointer-events: none; z-index: 999; }  
.burst-particle {  
  position: absolute; border-radius: 50%; pointer-events: none;  
  animation: burst 0.8s var(--ease-out) forwards;  
}  
@keyframes burst {  
  0% { transform: translate(0,0) scale(1); opacity: 1; }  
  100% { transform: var(--tx,0) var(--ty,0) scale(0); opacity: 0; }  
}  
  
/* ═══════════════════════════════════════════  
   RANKING SCREEN  
═══════════════════════════════════════════ */  
.rank-header {  
  padding: calc(env(safe-area-inset-top) + 48px) 22px 24px;  
  background: linear-gradient(180deg, rgba(167,139,250,0.08), transparent);  
  border-bottom: 1px solid var(--border);  
  margin-bottom: 4px;  
}  
.rank-title { font-size: 28px; font-weight: 800; margin-bottom: 4px; }  
.rank-sub { font-size: 13px; color: var(--text2); }  
  
/* Podium */  
.podium { display: flex; align-items: flex-end; justify-content: center; gap: 8px; padding: 24px 22px 0; }  
.podium-item {  
  flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;  
  animation: podiumRise 0.6s var(--ease-spring) both;  
}  
.podium-item:nth-child(1) { animation-delay: 0.1s; }  
.podium-item:nth-child(2) { animation-delay: 0s; }  
.podium-item:nth-child(3) { animation-delay: 0.2s; }  
@keyframes podiumRise {  
  from { opacity: 0; transform: translateY(30px); }  
  to { opacity: 1; transform: translateY(0); }  
}  
.pod-crown { font-size: 22px; animation: crownBounce 2s ease-in-out infinite; }  
@keyframes crownBounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }  
.pod-av {  
  border-radius: 50%; display: flex; align-items: center; justify-content: center;  
  border: 3px solid var(--border2); position: relative;  
}  
.podium-item.p1 .pod-av {  
  width: 72px; height: 72px; font-size: 34px;  
  border-color: var(--amber);  
  box-shadow: 0 0 24px rgba(255,196,83,0.3), 0 0 48px rgba(255,196,83,0.1);  
}  
.podium-item.p2 .pod-av, .podium-item.p3 .pod-av { width: 56px; height: 56px; font-size: 26px; }  
.pod-name { font-size: 13px; font-weight: 700; text-align: center; }  
.pod-pts { font-size: 11px; color: var(--text3); }  
.pod-block {  
  width: 100%; border-radius: 10px 10px 0 0; display: flex; align-items: center; justify-content: center;  
  font-size: 22px; font-weight: 800; color: rgba(255,255,255,0.3);  
  font-family: 'Bricolage Grotesque', sans-serif;  
}  
.podium-item.p1 .pod-block { height: 60px; background: linear-gradient(180deg, rgba(255,196,83,0.2), rgba(255,196,83,0.05)); border: 1px solid rgba(255,196,83,0.2); }  
.podium-item.p2 .pod-block { height: 44px; background: linear-gradient(180deg, rgba(192,192,192,0.15), rgba(192,192,192,0.04)); border: 1px solid rgba(192,192,192,0.15); }  
.podium-item.p3 .pod-block { height: 32px; background: linear-gradient(180deg, rgba(176,138,100,0.15), rgba(176,138,100,0.04)); border: 1px solid rgba(176,138,100,0.15); }  
  
/* Rest of ranking */  
.rank-list { padding: 16px 22px; }  
.rank-row {  
  display: flex; align-items: center; gap: 12px;  
  background: var(--surface); border: 1px solid var(--border);  
  border-radius: var(--r-md); padding: 14px;  
  margin-bottom: 8px;  
  animation: rankSlide 0.4s var(--ease-out) both;  
}  
@keyframes rankSlide {  
  from { opacity: 0; transform: translateX(-12px); }  
  to { opacity: 1; transform: translateX(0); }  
}  
.rank-pos { font-size: 14px; font-weight: 800; color: var(--text3); width: 22px; text-align: center; font-family: 'Bricolage Grotesque', sans-serif; }  
.rank-av { width: 42px; height: 42px; border-radius: 50%; font-size: 22px; background: var(--surface2); display: flex; align-items: center; justify-content: center; }  
.rank-info { flex: 1; }  
.rank-name { font-size: 14px; font-weight: 600; }  
.rank-meta { font-size: 12px; color: var(--text3); margin-top: 2px; }  
.rank-score { font-size: 20px; font-weight: 800; color: var(--neon); font-family: 'Bricolage Grotesque', sans-serif; }  
  
/* Star of week */  
.star-card {  
  margin: 16px 22px 0;  
  background: linear-gradient(135deg, rgba(255,196,83,0.12), rgba(255,107,138,0.08));  
  border: 1px solid rgba(255,196,83,0.2);  
  border-radius: var(--r-lg); padding: 18px;  
  display: flex; align-items: center; gap: 14px;  
}  
.star-icon { font-size: 36px; animation: starPulse 2s ease-in-out infinite; }  
@keyframes starPulse { 0%,100%{transform:scale(1) rotate(0)} 50%{transform:scale(1.1) rotate(10deg)} }  
.star-label { font-size: 11px; color: var(--amber); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }  
.star-name { font-size: 20px; font-weight: 800; }  
.star-pts { font-size: 13px; color: var(--text2); }  
  
/* ═══════════════════════════════════════════  
   PROFILE SCREEN  
═══════════════════════════════════════════ */  
.prof-header {  
  padding: calc(env(safe-area-inset-top) + 48px) 22px 28px;  
  text-align: center; position: relative;  
}  
.prof-av-wrap { position: relative; display: inline-block; margin-bottom: 14px; }  
.prof-av {  
  width: 90px; height: 90px; border-radius: 50%; font-size: 46px;  
  background: var(--surface2); display: flex; align-items: center; justify-content: center;  
  border: 3px solid rgba(125,249,255,0.3);  
  box-shadow: 0 0 30px rgba(125,249,255,0.15);  
  margin: 0 auto;  
  animation: profileFloat 4s ease-in-out infinite;  
}  
@keyframes profileFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }  
.prof-ring {  
  position: absolute; inset: -6px; border-radius: 50%;  
  border: 2px solid transparent;  
  background: linear-gradient(var(--bg), var(--bg)) padding-box,  
              linear-gradient(135deg, var(--neon), var(--neon2)) border-box;  
  animation: ringRotate 4s linear infinite;  
}  
@keyframes ringRotate { to { transform: rotate(360deg); } }  
  
.prof-name { font-size: 24px; font-weight: 800; margin-bottom: 4px; }  
.prof-role { font-size: 13px; color: var(--text2); }  
  
.prof-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 0 22px 20px; }  
.stat-pill {  
  background: var(--surface); border: 1px solid var(--border);  
  border-radius: var(--r-md); padding: 16px 10px; text-align: center;  
}  
.stat-val { font-size: 26px; font-weight: 800; font-family: 'Bricolage Grotesque', sans-serif; }  
.stat-lbl { font-size: 11px; color: var(--text3); margin-top: 3px; }  
  
.hist-section { padding: 0 22px; }  
.hist-item {  
  display: flex; align-items: center; gap: 12px;  
  background: var(--surface); border: 1px solid var(--border);  
  border-radius: var(--r-md); padding: 13px;  
  margin-bottom: 8px;  
  animation: histIn 0.3s var(--ease-out) both;  
}  
@keyframes histIn {  
  from { opacity: 0; transform: translateY(8px); }  
  to { opacity: 1; transform: translateY(0); }  
}  
.hist-ico { font-size: 22px; width: 40px; height: 40px; background: var(--surface2); border-radius: 10px; display: flex; align-items: center; justify-content: center; }  
.hist-info { flex: 1; }  
.hist-name { font-size: 14px; font-weight: 600; }  
.hist-date { font-size: 12px; color: var(--text3); margin-top: 2px; }  
.hist-pts { font-size: 16px; font-weight: 800; color: var(--green); font-family: 'Bricolage Grotesque', sans-serif; }  
  
/* ═══════════════════════════════════════════  
   MANAGE SCREEN  
═══════════════════════════════════════════ */  
.manage-header {  
  padding: calc(env(safe-area-inset-top) + 48px) 22px 20px;  
  background: linear-gradient(180deg, rgba(255,196,83,0.05), transparent);  
  border-bottom: 1px solid var(--border);  
  margin-bottom: 4px;  
}  
.manage-title { font-size: 28px; font-weight: 800; }  
.manage-sub { font-size: 13px; color: var(--text2); margin-top: 4px; }  
  
.add-task-btn {  
  margin: 16px 22px;  
  background: linear-gradient(135deg, var(--neon), var(--blue));  
  border: none; border-radius: var(--r-md);  
  padding: 16px; width: calc(100% - 44px);  
  font-family: 'Bricolage Grotesque', sans-serif; font-size: 15px; font-weight: 700;  
  color: #0A0A14; cursor: pointer;  
  display: flex; align-items: center; justify-content: center; gap: 8px;  
  transition: all 0.2s var(--ease-spring);  
  box-shadow: 0 4px 20px rgba(125,249,255,0.25);  
}  
.add-task-btn:active { transform: scale(0.97); }  
  
.manage-item {  
  display: flex; align-items: center; gap: 12px;  
  background: var(--surface); border: 1px solid var(--border);  
  border-radius: var(--r-md); padding: 14px;  
  margin-bottom: 8px; transition: all 0.2s;  
}  
.mi-icon { font-size: 22px; width: 44px; height: 44px; background: var(--surface2); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }  
.mi-info { flex: 1; min-width: 0; }  
.mi-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }  
.mi-meta { font-size: 12px; color: var(--text3); margin-top: 3px; }  
.mi-actions { display: flex; gap: 6px; }  
.mi-btn {  
  padding: 7px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;  
  border: none; cursor: pointer; transition: all 0.15s var(--ease-spring);  
}  
.mi-btn:active { transform: scale(0.9); }  
.mi-edit { background: rgba(125,249,255,0.1); color: var(--neon); }  
.mi-del { background: rgba(255,107,138,0.1); color: var(--rose); }  
  
/* ═══════════════════════════════════════════  
   MODAL  
═══════════════════════════════════════════ */  
.modal-overlay {  
  position: fixed; inset: 0; z-index: 200;  
  background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);  
  display: none; align-items: flex-end;  
  transition: opacity 0.3s;  
}  
.modal-overlay.open { display: flex; }  
.modal-sheet {  
  background: var(--bg2); width: 100%;  
  border-radius: 28px 28px 0 0;  
  padding: 20px 22px max(28px, env(safe-area-inset-bottom));  
  max-height: 92vh; overflow-y: auto;  
  animation: sheetUp 0.4s var(--ease-spring);  
  border-top: 1px solid var(--border2);  
}  
@keyframes sheetUp {  
  from { transform: translateY(100%); opacity: 0; }  
  to { transform: translateY(0); opacity: 1; }  
}  
.sheet-handle { width: 36px; height: 4px; background: var(--text3); border-radius: 2px; margin: 0 auto 20px; }  
.sheet-title { font-size: 20px; font-weight: 800; margin-bottom: 20px; }  
  
.f-label { font-size: 12px; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 7px; }  
.f-input, .f-select {  
  width: 100%; padding: 14px 16px;  
  background: var(--surface); border: 1.5px solid var(--border2);  
  border-radius: var(--r-sm); color: var(--text);  
  font-family: 'Instrument Sans', sans-serif; font-size: 15px;  
  outline: none; transition: border-color 0.2s, box-shadow 0.2s;  
  margin-bottom: 14px;  
}  
.f-input:focus, .f-select:focus { border-color: var(--neon); box-shadow: 0 0 0 3px rgba(125,249,255,0.1); }  
.f-select { appearance: none; }  
.f-row { display: flex; gap: 10px; }  
.f-row .f-grp { flex: 1; }  
.f-grp { margin-bottom: 0; }  
  
.emoji-pick { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }  
.ep-btn {  
  width: 46px; height: 46px; border-radius: 12px;  
  background: var(--surface); border: 2px solid var(--border);  
  font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center;  
  transition: all 0.2s var(--ease-spring);  
}  
.ep-btn.sel {  
  border-color: var(--neon); background: rgba(125,249,255,0.08);  
  transform: scale(1.1); box-shadow: 0 0 12px rgba(125,249,255,0.2);  
}  
.ep-btn:active { transform: scale(0.9); }  
  
/* ═══════════════════════════════════════════  
   DAY PICKER (modal)  
═══════════════════════════════════════════ */  
.day-picker {  
  display: flex; gap: 6px; margin-bottom: 16px; justify-content: space-between;  
}  
.day-btn {  
  flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px;  
  background: var(--surface); border: 1.5px solid var(--border);  
  border-radius: 10px; padding: 8px 4px;  
  cursor: pointer; transition: all 0.2s var(--ease-spring);  
}  
.day-btn.sel {  
  background: rgba(125,249,255,0.1); border-color: var(--neon);  
  box-shadow: 0 0 10px rgba(125,249,255,0.15);  
}  
.day-btn:active { transform: scale(0.9); }  
.day-letter { font-size: 11px; font-weight: 800; font-family: 'Bricolage Grotesque', sans-serif; color: var(--text3); transition: color 0.2s; }  
.day-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--border2); transition: background 0.2s; }  
.day-btn.sel .day-letter { color: var(--neon); }  
.day-btn.sel .day-dot { background: var(--neon); box-shadow: 0 0 5px var(--neon); }  
  
/* ─── freq/days toggle ─── */  
.freq-days-toggle { margin-bottom: 12px; }  
.toggle-row { display: flex; background: var(--surface); border-radius: var(--r-sm); padding: 4px; gap: 4px; margin-bottom: 12px; }  
.toggle-opt {  
  flex: 1; text-align: center; padding: 8px 4px; border-radius: 8px;  
  font-size: 12px; font-weight: 600; color: var(--text3); cursor: pointer;  
  transition: all 0.2s var(--ease-spring);  
}  
.toggle-opt.active { background: var(--surface2); color: var(--text); }  
  
/* ═══════════════════════════════════════════  
   WEEKLY CALENDAR VIEW  
═══════════════════════════════════════════ */  
.week-calendar {  
  margin: 0 22px 20px;  
  background: var(--surface); border: 1px solid var(--border);  
  border-radius: var(--r-lg); overflow: hidden;  
}  
.wc-header {  
  display: flex; align-items: center; justify-content: space-between;  
  padding: 14px 16px 10px;  
}  
.wc-title { font-size: 14px; font-weight: 700; font-family: 'Bricolage Grotesque', sans-serif; }  
.wc-toggle {  
  font-size: 11px; font-weight: 600; color: var(--neon); cursor: pointer;  
  background: rgba(125,249,255,0.08); border: 1px solid rgba(125,249,255,0.2);  
  padding: 4px 10px; border-radius: 20px;  
}  
.wc-days-row {  
  display: grid; grid-template-columns: repeat(7, 1fr);  
  padding: 0 12px 4px; gap: 4px;  
}  
.wc-day-col {  
  display: flex; flex-direction: column; align-items: center; gap: 4px;  
  cursor: pointer; transition: opacity 0.2s;  
}  
.wc-day-col.other-day { opacity: 0.45; }  
.wc-day-col.today .wc-day-label { color: var(--neon); }  
.wc-day-label {  
  font-size: 10px; font-weight: 700; color: var(--text3);  
  font-family: 'Bricolage Grotesque', sans-serif; letter-spacing: 0.3px;  
}  
.wc-day-num {  
  width: 28px; height: 28px; border-radius: 50%;  
  display: flex; align-items: center; justify-content: center;  
  font-size: 13px; font-weight: 700; font-family: 'Bricolage Grotesque', sans-serif;  
  color: var(--text2); transition: all 0.2s var(--ease-spring);  
}  
.wc-day-col.today .wc-day-num {  
  background: var(--neon); color: #0A0A14;  
  box-shadow: 0 0 12px rgba(125,249,255,0.4);  
}  
.wc-day-col.selected-day .wc-day-num {  
  background: var(--surface2); color: var(--text);  
  border: 1.5px solid var(--border2);  
}  
.wc-task-dots { display: flex; gap: 2px; flex-wrap: wrap; justify-content: center; min-height: 8px; padding: 2px 0 6px; }  
.wc-dot {  
  width: 5px; height: 5px; border-radius: 50%;  
  transition: transform 0.2s var(--ease-spring);  
}  
.wc-day-col:hover .wc-dot { transform: scale(1.3); }  
  
/* Day detail panel — now a collapsible accordion */  
.wc-detail {  
  border-top: 1px solid var(--border);  
  overflow: hidden;  
}  
  
/* Each day accordion row */  
.wc-accord {  
  border-bottom: 1px solid var(--border);  
  overflow: hidden;  
}  
.wc-accord:last-child { border-bottom: none; }  
  
.wc-accord-header {  
  display: flex; align-items: center; gap: 10px;  
  padding: 11px 14px; cursor: pointer;  
  transition: background 0.2s;  
  user-select: none;  
}  
.wc-accord-header:active { background: rgba(255,255,255,0.03); }  
  
.wc-accord-day {  
  font-size: 13px; font-weight: 700;  
  font-family: 'Bricolage Grotesque', sans-serif; color: var(--text);  
  flex: 1;  
}  
.wc-accord-day.today-label { color: var(--neon); }  
  
.wc-accord-meta {  
  display: flex; align-items: center; gap: 8px;  
}  
.wc-accord-count {  
  font-size: 11px; font-weight: 700;  
  background: rgba(125,249,255,0.1); color: var(--neon);  
  border: 1px solid rgba(125,249,255,0.2);  
  border-radius: 20px; padding: 2px 8px;  
}  
.wc-accord-count.all-done {  
  background: rgba(52,238,154,0.1); color: var(--green);  
  border-color: rgba(52,238,154,0.2);  
}  
.wc-accord-count.empty {  
  background: rgba(255,255,255,0.04); color: var(--text3);  
  border-color: var(--border);  
}  
  
.wc-accord-arrow {  
  font-size: 12px; color: var(--text3);  
  transition: transform 0.3s var(--ease-spring);  
  display: inline-block;  
}  
.wc-accord.open .wc-accord-arrow { transform: rotate(180deg); }  
  
.wc-accord-body {  
  max-height: 0; overflow: hidden;  
  transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1),  
              padding 0.3s ease;  
  padding: 0 14px;  
}  
.wc-accord.open .wc-accord-body {  
  max-height: 600px;  
  padding: 0 14px 10px;  
}  
  
.wc-task-chip {  
  display: flex; align-items: center; gap: 8px;  
  background: var(--bg); border-radius: 8px; padding: 7px 10px;  
  margin-bottom: 5px; transition: opacity 0.2s;  
  animation: chipIn 0.3s var(--ease-spring) both;  
}  
@keyframes chipIn {  
  from { opacity: 0; transform: translateY(-4px); }  
  to   { opacity: 1; transform: translateY(0); }  
}  
.wc-task-chip.done-chip { opacity: 0.45; }  
.wc-chip-icon { font-size: 14px; }  
.wc-chip-name { flex: 1; font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }  
.wc-chip-pts { font-size: 11px; font-weight: 700; color: var(--neon); }  
.wc-chip-done { font-size: 12px; color: var(--green); }  
.wc-empty-day { text-align: center; padding: 10px 0; color: var(--text3); font-size: 13px; }

/* Calendar chip interactive states */
.wc-task-chip { cursor: pointer; }
.wc-task-chip.locked-chip { cursor: default; opacity: 0.5; }
.wc-task-chip:not(.locked-chip):active { transform: scale(0.97); }

/* Chip flash green on complete */
@keyframes chipFlashGreen {
  0%   { box-shadow: 0 0 0 0 rgba(52,238,154,0); }
  40%  { box-shadow: 0 0 0 4px rgba(52,238,154,0.35); }
  100% { box-shadow: 0 0 0 0 rgba(52,238,154,0); }
}
.wc-task-chip.chip-completing {
  animation: chipFlashGreen 0.5s ease forwards;
}

/* Chip shake + red flash on uncomplete */
@keyframes chipShake {
  0%   { transform: translateX(0); }
  20%  { transform: translateX(-5px); }
  40%  { transform: translateX(4px); }
  60%  { transform: translateX(-3px); }
  80%  { transform: translateX(2px); }
  100% { transform: translateX(0); }
}
@keyframes chipFlashRed {
  0%   { box-shadow: 0 0 0 0 rgba(255,107,138,0); }
  35%  { box-shadow: 0 0 0 4px rgba(255,107,138,0.35); }
  100% { box-shadow: 0 0 0 0 rgba(255,107,138,0); }
}
.wc-task-chip.chip-uncompleting {
  animation: chipShake 0.4s cubic-bezier(0.36,0.07,0.19,0.97) both,
             chipFlashRed 0.45s ease both;
}  
  
.assign-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }  
.assign-item {  
  display: flex; align-items: center; gap: 8px;  
  background: var(--surface); border: 1.5px solid var(--border);  
  border-radius: var(--r-sm); padding: 10px;  
  cursor: pointer; transition: all 0.2s var(--ease-spring);  
}  
.assign-item.sel {  
  border-color: var(--neon); background: rgba(125,249,255,0.07);  
  box-shadow: 0 0 10px rgba(125,249,255,0.1);  
}  
.assign-item:active { transform: scale(0.95); }  
.ai-av { font-size: 20px; width: 34px; height: 34px; background: var(--surface2); border-radius: 50%; display: flex; align-items: center; justify-content: center; }  
.ai-name { font-size: 13px; font-weight: 600; }  
.ai-pts { font-size: 11px; color: var(--text3); }  
  
/* ═══════════════════════════════════════════  
   TOAST  
═══════════════════════════════════════════ */  
.toast {  
  position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%) translateY(16px);  
  background: var(--surface); border: 1px solid var(--border2);  
  color: var(--text); padding: 12px 20px; border-radius: 30px;  
  font-size: 14px; font-weight: 500; z-index: 400; opacity: 0;  
  transition: all 0.35s var(--ease-spring); white-space: nowrap; pointer-events: none;  
  backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0,0,0,0.3);  
}  
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }  
  
/* ═══════════════════════════════════════════  
   LOADING  
═══════════════════════════════════════════ */  
.loading-screen {  
  position: fixed; inset: 0; z-index: 600;  
  background: var(--bg); display: flex; flex-direction: column;  
  align-items: center; justify-content: center; gap: 16px;  
  transition: opacity 0.5s, transform 0.5s;  
}  
.loading-screen.hidden { opacity: 0; pointer-events: none; transform: scale(0.96); }  
.loading-logo { font-size: 56px; animation: floatLogo 2s ease-in-out infinite; }  
.loading-bar { width: 160px; height: 3px; background: var(--surface2); border-radius: 2px; overflow: hidden; }  
.loading-fill { height: 100%; background: linear-gradient(90deg, var(--neon), var(--blue)); width: 0%; transition: width 0.3s; border-radius: 2px; }  
.loading-text { color: var(--text2); font-size: 14px; }  
  
/* ═══════════════════════════════════════════  
   INSTALL PROMPT  
═══════════════════════════════════════════ */  
.install-banner {  
  margin: 0 22px 16px;  
  background: linear-gradient(135deg, rgba(125,249,255,0.08), rgba(167,139,250,0.08));  
  border: 1px solid rgba(125,249,255,0.2);  
  border-radius: var(--r-md); padding: 14px 16px;  
  display: flex; align-items: center; gap: 12px;  
  animation: slideDown 0.5s var(--ease-spring);  
}  
@keyframes slideDown {  
  from { opacity: 0; transform: translateY(-10px); }  
  to { opacity: 1; transform: translateY(0); }  
}  
.install-text { flex: 1; font-size: 13px; color: var(--text2); }  
.install-text strong { color: var(--text); display: block; font-size: 14px; margin-bottom: 2px; }  
.install-btn {  
  background: var(--neon); color: #0A0A14; border: none;  
  padding: 8px 14px; border-radius: 8px; font-size: 13px; font-weight: 700;  
  cursor: pointer; white-space: nowrap; font-family: 'Bricolage Grotesque', sans-serif;  
}  
.install-close { font-size: 18px; color: var(--text3); cursor: pointer; padding: 4px; }  
  
/* Empty */  
.empty-state { text-align: center; padding: 40px 20px; color: var(--text3); }  
.empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }  
.empty-title { font-size: 16px; font-weight: 700; color: var(--text2); margin-bottom: 6px; }  
.empty-sub { font-size: 13px; }  
  
/* Manage section padding fix */  
.manage-list { padding: 0 22px; }  
  
/* ─── Scroll hint ─── */  
::-webkit-scrollbar { display: none; }

/* ─── Admin pending notification ─── */
.admin-pending-banner {
  margin: max(env(safe-area-inset-top), 12px) 22px 0;
  background: linear-gradient(135deg, rgba(255,196,83,0.12), rgba(255,107,138,0.08));
  border: 1.5px solid rgba(255,196,83,0.35);
  border-radius: var(--r-lg); padding: 16px 18px;
  display: flex; align-items: center; gap: 14px;
  animation: slideDown 0.5s var(--ease-spring);
}
.admin-pending-banner .apb-icon { font-size: 32px; flex-shrink: 0; }
.admin-pending-banner .apb-body { flex: 1; }
.admin-pending-banner .apb-title { font-size: 14px; font-weight: 700; color: var(--amber); margin-bottom: 4px; }
.admin-pending-banner .apb-sub { font-size: 12px; color: var(--text2); line-height: 1.4; }
.admin-pending-banner .apb-actions { display: flex; gap: 8px; margin-top: 12px; }
.apb-btn-accept {
  flex: 1; padding: 10px; border: none; border-radius: 10px;
  background: linear-gradient(135deg, var(--amber), var(--rose));
  color: #0A0A14; font-size: 13px; font-weight: 700; cursor: pointer;
  font-family: 'Bricolage Grotesque', sans-serif;
  transition: all 0.2s var(--ease-spring);
}
.apb-btn-accept:active { transform: scale(0.96); }
.apb-btn-decline {
  padding: 10px 14px; border: 1.5px solid var(--border2); border-radius: 10px;
  background: transparent; color: var(--text3); font-size: 13px; cursor: pointer;
  font-family: 'Instrument Sans', sans-serif;
  transition: all 0.2s;
}

/* ─── Role badge in manage members ─── */
.role-badge-admin {
  display: inline-flex; align-items: center; gap: 4px;
  background: rgba(255,196,83,0.15); color: var(--amber);
  border: 1px solid rgba(255,196,83,0.3);
  border-radius: 20px; padding: 2px 10px; font-size: 11px; font-weight: 700;
}
.role-badge-user {
  display: inline-flex; align-items: center; gap: 4px;
  background: rgba(148,163,184,0.1); color: var(--text3);
  border: 1px solid rgba(148,163,184,0.2);
  border-radius: 20px; padding: 2px 10px; font-size: 11px; font-weight: 600;
}
.role-badge-pending {
  display: inline-flex; align-items: center; gap: 4px;
  background: rgba(255,196,83,0.08); color: rgba(255,196,83,0.7);
  border: 1px solid rgba(255,196,83,0.2);
  border-radius: 20px; padding: 2px 10px; font-size: 11px; font-weight: 600;
  font-style: italic;
}  
</style>  
  
</head>  
<body>  
  
<!-- Loading -->  
  
<div class="loading-screen" id="loadingScreen">  
  <div class="loading-logo">🏠</div>  
  <div class="loading-bar"><div class="loading-fill" id="loadingFill"></div></div>  
  <div class="loading-text">Cargando Hogar...</div>  
</div>  
  
<!-- Auth -->  
  
<div id="authScreen">  
  <div class="auth-header">
    <div class="auth-logo">🏠</div>  
    <div class="auth-title">Hogar</div>  
    <div class="auth-sub">Tareas en familia, diversión en equipo</div>
  </div>  
  
  <!-- Step 1: Choose action -->
  <div class="auth-step active" id="authStep1">  
    <button class="btn-glow" onclick="authGo('login')" style="margin-bottom:10px">🔑 Ya tengo cuenta — Ingresar</button>
    <button class="btn-glow" onclick="authGo('create')" style="margin-bottom:10px;background:linear-gradient(135deg,var(--neon2),var(--blue))">🏠 Crear nuevo hogar</button>
    <button class="btn-ghost" onclick="authGo('join')">🔗 Unirme a un hogar existente</button>
    <div style="text-align:center;margin-top:16px;font-size:12px;color:var(--text3);line-height:1.6">  
      ¿Ya tienes cuenta? <strong style="color:var(--text2)">Ingresa</strong> con tu correo y código.<br>
      ¿Primera vez? <strong style="color:var(--text2)">Crea</strong> o <strong style="color:var(--text2)">únete</strong> a un hogar.
    </div>  
  </div>  

  <!-- Step Login: email + group code -->
  <div class="auth-step" id="authStepLogin">
    <div class="auth-label">Tu correo electrónico</div>
    <input class="auth-input" id="loginEmail" type="email" placeholder="tucorreo@ejemplo.com" />
    <div class="auth-label" style="margin-top:4px">Código del hogar</div>
    <input class="code-input" id="loginCode" maxlength="8" placeholder="ABCD1234" oninput="this.value=this.value.toUpperCase()" />
    <button class="btn-glow" onclick="loginUser()">Ingresar →</button>
    <button class="btn-ghost" onclick="authBack()">← Atrás</button>
    <div style="text-align:center;margin-top:14px;font-size:12px;color:var(--text3)">
      ¿Nunca te has registrado? <span onclick="authGo('join')" style="color:var(--neon);cursor:pointer;font-weight:600">Únete aquí</span>
    </div>
  </div>

  <!-- Step 2a: Create home -->  
  <div class="auth-step" id="authStepCreate">
    <div class="auth-label">Tu correo electrónico</div>
    <input class="auth-input" id="createEmail" type="email" placeholder="tucorreo@ejemplo.com" />
    <div class="auth-label" style="margin-top:4px">Nombre del hogar</div>
    <input class="auth-input" id="homeName" placeholder="Los García, Casa Bonita..." />
    <div class="auth-label" style="margin-top:4px">Tu nombre</div>  
    <input class="auth-input" id="createUserName" placeholder="¿Cómo te llamamos?" />  
    <div class="auth-label" style="margin-top:4px">Elige tu avatar</div>  
    <div class="avatar-pick" id="avatarPick"></div>  
    <button class="btn-glow" onclick="createHome()">Crear hogar 🚀</button>  
    <button class="btn-ghost" onclick="authBack()">← Atrás</button>  
  </div>  
  
  <!-- Step 2b: Join -->  
  <div class="auth-step" id="authStepJoin">
    <div class="auth-label">Tu correo electrónico</div>
    <input class="auth-input" id="joinEmail" type="email" placeholder="tucorreo@ejemplo.com" />
    <div class="auth-label" style="margin-top:4px">Tu nombre</div>  
    <input class="auth-input" id="joinUserName" placeholder="¿Cómo te llamamos?" />  
    <div class="auth-label" style="margin-top:4px">Elige tu avatar</div>  
    <div class="avatar-pick" id="avatarPickJoin"></div>  
    <div class="auth-label" style="margin-top:4px">Código del hogar</div>  
    <input class="code-input" id="joinCode" maxlength="8" placeholder="ABCD1234" oninput="this.value=this.value.toUpperCase()" />  
    <button class="btn-glow" onclick="joinHome()">Unirme 🏠</button>  
    <button class="btn-ghost" onclick="authBack()">← Atrás</button>  
  </div>  
  
  <!-- Step 3: Home created - show code -->  
  <div class="auth-step" id="authStepCode">  
    <div style="text-align:center;margin-bottom:20px">  
      <div style="font-size:40px;margin-bottom:10px">🎉</div>  
      <div style="font-size:20px;font-weight:800;color:var(--text);margin-bottom:4px">¡Hogar creado!</div>  
      <div style="font-size:13px;color:var(--text2)">Comparte este código con tu familia:</div>  
    </div>
    <div style="background:linear-gradient(135deg,rgba(125,249,255,0.08),rgba(167,139,250,0.05));border:1.5px solid rgba(125,249,255,0.25);border-radius:var(--r-lg);padding:20px;margin-bottom:16px;text-align:center">
      <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Código de acceso</div>
      <div id="displayCodeChars" style="display:flex;gap:5px;justify-content:center;flex-wrap:wrap;margin-bottom:8px"></div>
      <div id="displayCode" style="display:none"></div>
      <div style="font-size:11px;color:var(--text3);margin-top:10px">8 caracteres · generado aleatoriamente</div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:16px">
      <button onclick="copyCode()" style="flex:1;padding:12px;background:rgba(125,249,255,0.1);border:1.5px solid rgba(125,249,255,0.25);border-radius:var(--r-sm);color:var(--neon);font-size:13px;font-weight:700;cursor:pointer;font-family:'Bricolage Grotesque',sans-serif">📋 Copiar</button>
      <button onclick="shareCode()" style="flex:1;padding:12px;background:rgba(167,139,250,0.1);border:1.5px solid rgba(167,139,250,0.25);border-radius:var(--r-sm);color:var(--neon2);font-size:13px;font-weight:700;cursor:pointer;font-family:'Bricolage Grotesque',sans-serif">🔗 Compartir</button>
    </div>
    <div style="background:rgba(255,196,83,0.08);border:1px solid rgba(255,196,83,0.2);border-radius:12px;padding:12px 14px;margin-bottom:16px;font-size:13px;color:var(--amber);display:flex;gap:10px;align-items:flex-start">  
      <span>👑</span>  
      <span>Eres el <strong>administrador</strong> del hogar. Solo tú podrás modificar los puntos de las tareas.</span>  
    </div>  
    <button class="btn-glow" onclick="enterApp()">Entrar al hogar ✨</button>  
  </div>  
</div>  
  
<!-- Burst container -->  
  
<div class="burst-container" id="burstContainer"></div>  
  
<!-- Toast -->  
  
<div class="toast" id="toast"></div>  
  
<!-- Main App -->  
  
<div id="app" style="display:none">  
  
  <!-- ══ HOME ══ -->  
  
  <div class="screen active" id="screen-home">  
    <!-- Install banner -->  
    <div class="install-banner" id="installBanner" style="display:none;margin-top: max(env(safe-area-inset-top), 12px)">  
      <div>📲</div>  
      <div class="install-text">  
        <strong>Instalar en tu celular</strong>  
        Acceso rápido sin abrir el navegador  
      </div>  
      <button class="install-btn" id="installBtn">Instalar</button>  
      <div class="install-close" onclick="document.getElementById('installBanner').style.display='none'">×</div>  
    </div>

    <!-- Admin pending banner (hidden - kept for compatibility) -->
    <div class="admin-pending-banner" id="adminPendingBanner" style="display:none">
      <div class="apb-icon">👑</div>
      <div class="apb-body">
        <div class="apb-title">Cambio de rol</div>
        <div class="apb-sub"></div>
      </div>
    </div>  
  
```  
<div class="home-header">  
  <div class="home-top">  
    <div>  
      <div class="home-greeting" id="hdrGreeting">¡Hola! ☀️</div>  
      <div class="home-name"><span id="hdrName">...</span></div>  
    </div>  
    <div class="avatar-pill" onclick="showScreen('profile')">  
      <div class="avatar-pill-icon" id="hdrAvatar">👤</div>  
      <div class="avatar-pill-pts" id="hdrPts">0</div>  
    </div>  
  </div>  
  
  <!-- Hero card -->  
  <div class="hero-card">  
    <div class="hero-grid">  
      <div>  
        <div class="hero-pts-label">Puntos esta semana</div>  
        <div class="hero-pts" id="heroPts">0</div>  
        <div class="hero-pts-sub" id="heroSub">de 200 meta</div>  
        <div class="hero-streak" id="heroStreak">🔥 0 días de racha</div>  
      </div>  
      <div class="donut-wrap">  
        <svg class="donut-svg" width="80" height="80" viewBox="0 0 80 80">  
          <defs>  
            <linearGradient id="donutGrad" x1="0%" y1="0%" x2="100%" y2="100%">  
              <stop offset="0%" style="stop-color:#7DF9FF"/>  
              <stop offset="100%" style="stop-color:#A78BFA"/>  
            </linearGradient>  
          </defs>  
          <circle class="donut-bg" cx="40" cy="40" r="33"/>  
          <circle class="donut-fill" id="donutFill" cx="40" cy="40" r="33"/>  
        </svg>  
        <div class="donut-text">  
          <div class="donut-pct" id="donutPct">0%</div>  
          <div class="donut-lbl">hoy</div>  
        </div>  
      </div>  
    </div>  
  </div>  
  
  <!-- Week bar -->  
  <div class="week-section">  
    <div class="week-head">  
      <div class="week-title">Meta semanal</div>  
      <div class="week-val" id="weekVal">0 / 200 pts</div>  
    </div>  
    <div class="week-track"><div class="week-fill" id="weekFill" style="width:0%"></div></div>  
  </div>  
</div>  
  
<!-- Weekly Calendar -->  
<div class="week-calendar" id="weekCalendar">  
  <div class="wc-header">  
    <div class="wc-title">📅 Mi semana</div>  
    <div class="wc-toggle" id="wcToggleBtn" onclick="toggleCalView()">Ver todo</div>  
  </div>  
  <div class="wc-days-row" id="wcDaysRow"></div>  
  <div class="wc-detail" id="wcDetail"></div>  
</div>  
  
<!-- User chips -->  
<div class="users-scroll" id="userScroll"></div>  
  
<!-- Filters -->  
<div class="filters">  
  <div class="chip active" onclick="setFilter('mine',this)">Mis tareas</div>  
  <div class="chip" onclick="setFilter('done',this)">Completadas</div>  
  <div class="chip" onclick="setFilter('all',this)">Todas</div>  
</div>  
  
<!-- Tasks -->  
<div class="tasks-section">  
  <div class="section-title">  
    <span id="tasksLabel">Tareas · 0 pendientes</span>  
    <span class="sec-add" onclick="openTaskModal()">+ Nueva</span>  
  </div>  
  <div id="taskList"></div>  
</div>  
```  
  
  </div>  
  
  <!-- ══ RANKING ══ -->  
  
  <div class="screen" id="screen-ranking">  
    <div class="rank-header">  
      <div class="rank-title">Ranking 🏆</div>  
      <div class="rank-sub" id="rankSub">Semana actual</div>  
    </div>  
    <div class="star-card" id="starCard">  
      <div class="star-icon">⭐</div>  
      <div>  
        <div class="star-label">Estrella de la semana</div>  
        <div class="star-name" id="starName">—</div>  
        <div class="star-pts" id="starPts">—</div>  
      </div>  
    </div>  
    <div class="podium" id="podium"></div>  
    <div class="rank-list" id="rankList"></div>  
  </div>  
  
  <!-- ══ PROFILE ══ -->  
  
  <div class="screen" id="screen-profile">  
    <div class="prof-header">  
      <div class="prof-av-wrap">  
        <div class="prof-av" id="profAv">👤</div>  
        <div class="prof-ring"></div>  
      </div>  
      <div class="prof-name" id="profName">—</div>  
      <div class="prof-role" id="profRole">Miembro del hogar</div>
      <div id="profEmail" style="font-size:12px;color:var(--text3);margin-top:4px"></div>
      <div id="adminBadgeProf" style="display:none;margin-top:8px;background:rgba(255,196,83,0.15);border:1px solid rgba(255,196,83,0.3);border-radius:20px;padding:4px 14px;font-size:12px;font-weight:700;color:var(--amber)">👑 Administrador</div>
      <div id="userBadgeProf" style="display:none;margin-top:8px;background:rgba(148,163,184,0.1);border:1px solid rgba(148,163,184,0.2);border-radius:20px;padding:4px 14px;font-size:12px;font-weight:600;color:var(--text3)">👤 Usuario</div>
    </div>  
    <div class="prof-stats">  
      <div class="stat-pill"><div class="stat-val" id="sPoints">0</div><div class="stat-lbl">Puntos</div></div>  
      <div class="stat-pill"><div class="stat-val" id="sDone">0</div><div class="stat-lbl">Completadas</div></div>  
      <div class="stat-pill"><div class="stat-val" id="sStreak">0🔥</div><div class="stat-lbl">Racha</div></div>  
    </div>  
    <div class="hist-section">  
      <div class="section-title" style="margin-bottom:12px">Historial reciente</div>  
      <div id="histList"></div>  
    </div>  
    <div style="padding:16px 22px 32px">
      <button class="btn-ghost" onclick="logout()" style="width:100%;border-color:rgba(255,107,138,0.3);color:var(--rose)">🚪 Cerrar sesión</button>
      <div style="text-align:center;margin-top:12px;font-size:12px;color:var(--text3)">
        Al cerrar sesión podrás ingresar con otra cuenta o crear un nuevo hogar.
      </div>
    </div>
  </div>  
  
  <!-- ══ MANAGE ══ -->  
  
  <div class="screen" id="screen-manage">  
    <div class="manage-header">  
      <div class="manage-title">Gestión 📋</div>  
      <div class="manage-sub">Administra las tareas del hogar</div>  
    </div>  
    <button class="add-task-btn" onclick="openTaskModal()">✦ Nueva tarea</button>  
    <div class="manage-list" id="manageList"></div>  
  </div>  
</div>  
  
<!-- Nav -->  
  
<nav class="nav" id="mainNav" style="display:none">  
  <div class="nav-item active" id="nav-home" onclick="showScreen('home')">  
    <div class="nav-icon">🏠</div>  
    <div class="nav-label">Inicio</div>  
    <div class="nav-indicator"></div>  
  </div>  
  <div class="nav-item" id="nav-ranking" onclick="showScreen('ranking')">  
    <div class="nav-icon">🏆</div>  
    <div class="nav-label">Ranking</div>  
    <div class="nav-indicator"></div>  
  </div>  
  <div class="nav-item" id="nav-profile" onclick="showScreen('profile')">  
    <div class="nav-icon">👤</div>  
    <div class="nav-label">Perfil</div>  
    <div class="nav-indicator"></div>  
  </div>  
  <div class="nav-item" id="nav-manage" onclick="showScreen('manage')">  
    <div class="nav-icon">⚙️</div>  
    <div class="nav-label">Gestión</div>  
    <div class="nav-indicator"></div>  
  </div>  
</nav>  
  
<!-- Task Modal -->  
  
<div class="modal-overlay" id="taskModal">  
  <div class="modal-sheet">  
    <div class="sheet-handle"></div>  
    <div class="sheet-title" id="modalTitle">✦ Nueva tarea</div>  
    <div class="f-label">Nombre</div>  
    <input class="f-input" id="fName" placeholder="Ej: Lavar los platos" />  
    <div class="f-label">Descripción (opcional)</div>  
    <input class="f-input" id="fDesc" placeholder="Detalles..." />  
    <div class="f-row">  
      <div class="f-grp" id="ptsGroup">  
        <div class="f-label">Puntos <span id="ptsAdminBadge" style="display:none;font-size:10px;background:rgba(255,196,83,0.15);color:var(--amber);border:1px solid rgba(255,196,83,0.3);border-radius:10px;padding:2px 7px;vertical-align:middle">Solo admin</span></div>  
        <input class="f-input" id="fPts" type="number" min="5" max="200" placeholder="20" />  
      </div>  
      <div class="f-grp">  
        <div class="f-label">Frecuencia</div>  
        <select class="f-select" id="fFreq" onchange="onFreqChange(this.value)">  
          <option value="Diaria">Diaria (todos los días)</option>  
          <option value="Semanal">Días específicos</option>  
          <option value="Quincenal">Quincenal</option>  
          <option value="Mensual">Mensual</option>  
        </select>  
      </div>  
    </div>  
    <!-- Day picker (shown when freq = Semanal or Diaria) -->  
    <div id="dayPickerWrap">  
      <div class="f-label">¿Qué días se realiza?</div>  
      <div class="day-picker" id="dayPicker"></div>  
    </div>  
    <div class="f-label">Icono</div>  
    <div class="emoji-pick" id="emojiPick"></div>  
    <div class="f-label">Asignar a</div>  
    <div class="assign-grid" id="assignGrid"></div>  
    <button class="btn-glow" onclick="saveTask()" style="margin-top:8px">Guardar tarea</button>  
    <button class="btn-ghost" onclick="closeModal()">Cancelar</button>  
  </div>  
</div>  
  
<!-- Manage Roles Modal -->

<div class="modal-overlay" id="transferAdminModal">
  <div class="modal-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">👥 Gestionar roles</div>
    <p style="font-size:14px;color:var(--text2);margin-bottom:20px;line-height:1.5">
      Cambia el rol de cualquier miembro. Tú seguirás siendo <strong style="color:var(--amber)">Administrador</strong>.
    </p>
    <div id="transferUserList"></div>
    <button class="btn-ghost" onclick="closeTransferModal()" style="margin-top:10px">Cerrar</button>
  </div>
</div>

<!-- Firebase SDK -->  
  
<script type="module">  
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';  
import { getDatabase, ref, set, get, push, onValue, update, remove, serverTimestamp }  
  from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';  
  
// ══════════════════════════════════════════════════════  
// 🔥 FIREBASE CONFIG — Reemplaza con tus datos  
// ══════════════════════════════════════════════════════  
const firebaseConfig = {  
  apiKey: "FIREBASE_API_KEY",  
  authDomain: "FIREBASE_PROJECT_ID.firebaseapp.com",  
  databaseURL: "https://FIREBASE_PROJECT_ID-default-rtdb.firebaseio.com",  
  projectId: "FIREBASE_PROJECT_ID",  
  storageBucket: "FIREBASE_PROJECT_ID.appspot.com",  
  messagingSenderId: "FIREBASE_SENDER_ID",  
  appId: "FIREBASE_APP_ID"  
};  
  
const fbApp = initializeApp(firebaseConfig);  
const db = getDatabase(fbApp);  
window._db = db;  
window._ref = ref;  
window._set = set;  
window._get = get;  
window._push = push;  
window._onValue = onValue;  
window._update = update;  
window._remove = remove;  
window._serverTimestamp = serverTimestamp;  
  
// After Firebase loaded, init app  
window.firebaseReady = true;  
window.dispatchEvent(new Event('firebase-ready'));  
</script>  
  
<script>  
// ══════════════════════════════════════════════════════  
// CONSTANTS & STATE  
// ══════════════════════════════════════════════════════  
const EMOJIS = ['🧹','🧺','🧽','🍽️','🚿','🪣','🛁','🴕','🪴','🐾','🛒','🧴','🍳','🧻','🗑️','🧸','🛏️','🪟','🚪','💧','🧼','🪥','🌿','🥘','🌺','🏡','✨','🪴'];  
const AVATARS = ['👨','👩','👧','👦','👴','👵','🧑','👶','🐶','🐱'];  
const WEEK_GOAL = 200;  
  
function formatDays(days, freq) {  
  if (!days || days.length === 0) return freq || 'Diaria';  
  if (days.length === 7) return 'Diaria';  
  if (days.length === 1) return DAY_FULL[days[0]];  
  if (days.length === 2) return days.map(d => DAY_NAMES[d]).join(' y ');  
  if (days.length <= 4) return days.map(d => DAY_NAMES[d]).join(', ');  
  return `${days.length} días`;  
}  
  
let state = {  
  homeId: null,  
  homeCode: null,  
  homeName: null,  
  ownerId: null,  
  myUserId: null,  
  currentViewUser: null,  
  users: {},  
  tasks: {},  
  filter: 'mine',  
  editingTaskId: null,  
  selectedEmoji: '🧹',  
  selectedAssignees: [],  
  selectedDays: [],  
  selectedAvatar: '👨',  
  selectedCalDay: new Date().getDay(),  
  calViewAll: false,  
  unsubTasks: null,  
  unsubUsers: null,  
  useLocalMode: false  
};  
  
// Local demo data (fallback if Firebase not configured)  
let localData = {  
  users: {  
    u1: { name: 'María', avatar: '👩', points: 145, streak: 5, history: [  
      { taskName: 'Lavar platos', pts: 25, icon: '🍽️', date: Date.now() - 3600000 },  
      { taskName: 'Barrer cocina', pts: 15, icon: '🧹', date: Date.now() - 86400000 }  
    ]},  
    u2: { name: 'Carlos', avatar: '👨', points: 98, streak: 3, history: [] },  
    u3: { name: 'Sofía', avatar: '👧', points: 210, streak: 7, history: [  
      { taskName: 'Limpiar baño', pts: 40, icon: '🚿', date: Date.now() - 7200000 }  
    ]},  
    u4: { name: 'Papá', avatar: '👴', points: 60, streak: 1, history: [] },  
  },  
  tasks: {  
    t1: { name: 'Lavar los platos', desc: 'Ollas y sartenes incluidos', pts: 25, freq: 'Diaria', days: [0,1,2,3,4,5,6], icon: '🍽️', done: false, assignees: ['u1','u2'] },  
    t2: { name: 'Barrer la cocina', desc: '', pts: 15, freq: 'Diaria', days: [0,1,2,3,4,5,6], icon: '🧹', done: false, assignees: [] },  
    t3: { name: 'Limpiar el baño', desc: 'Inodoro, lavabo y ducha', pts: 40, freq: 'Semanal', days: [6], icon: '🚿', done: true, completedBy: 'u3', completedAt: Date.now() },  
    t4: { name: 'Sacar la basura', desc: '', pts: 20, freq: 'Diaria', days: [0,3], icon: '🗑️', done: false, assignees: ['u1'] },  
    t5: { name: 'Lavar la ropa', desc: '', pts: 35, freq: 'Semanal', days: [2,5], icon: '🧺', done: false, assignees: ['u2','u4'] },  
    t6: { name: 'Compras supermercado', desc: 'Ver lista en la nevera', pts: 30, freq: 'Semanal', days: [5], icon: '🛒', done: false, assignees: ['u3','u4'] },  
  }  
};  
  
// ══════════════════════════════════════════════════════  
// INIT  
// ══════════════════════════════════════════════════════  
function checkFirebaseConfig() {  
  // Check if placeholder values exist  
  return typeof window._db !== 'undefined';  
}  
  
window.addEventListener('firebase-ready', () => { initApp(); }, { once: true });  
  
// Fallback: init without Firebase after 3s  
setTimeout(() => {  
  if (!window.firebaseReady) { initLocalMode(); }  
}, 3000);  
  
// Simulate loading  
let loadPct = 0;  
const loadInterval = setInterval(() => {  
  loadPct = Math.min(loadPct + Math.random() * 20, 90);  
  const el = document.getElementById('loadingFill');  
  if (el) el.style.width = loadPct + '%';  
}, 200);  
  
function finishLoading() {  
  clearInterval(loadInterval);  
  const el = document.getElementById('loadingFill');  
  if (el) el.style.width = '100%';  
  setTimeout(() => {  
    document.getElementById('loadingScreen').classList.add('hidden');  
  }, 400);  
}  
  
function initApp() {  
  finishLoading();  
  const stored = localStorage.getItem('hogar_session');  
  if (stored) {  
    try {  
      const session = JSON.parse(stored);  
      state.homeId = session.homeId;  
      state.homeCode = session.homeCode;  
      state.myUserId = session.userId;  
      state.homeName = session.homeName;  
      state.ownerId = session.ownerId || null;
      state.useLocalMode = session.useLocalMode || false;
      loadHomeData();  
      return;  
    } catch(e) {}  
  }  
  // No session — always show auth
  showAuth();
}

function showAuthPWA() {
  // Show auth screen even in demo mode so users enter their name
  document.getElementById('authScreen').style.display = 'flex';
  document.getElementById('authScreen').classList.remove('hidden');
  renderAvatarPickers();
  // Override createHome and joinHome to work locally
  state.useLocalMode = true;
}  
  
function initLocalMode() {  
  state.useLocalMode = true;  
  state.homeId = 'local';  
  state.myUserId = 'u1';  
  state.ownerId = 'u1'; // u1 is admin in demo  
  state.users = localData.users;  
  state.tasks = localData.tasks;  
  state.currentViewUser = 'u1';  
  finishLoading();  
  enterMainApp();  
}  
  
// ══════════════════════════════════════════════════════  
// AUTH  
// ══════════════════════════════════════════════════════  
let authMode = null;  
  
function showAuth() {  
  document.getElementById('authScreen').style.display = 'flex';  
  document.getElementById('authScreen').classList.remove('hidden');
  document.getElementById('app').style.display = 'none';
  document.getElementById('mainNav').style.display = 'none';
  state.useLocalMode = true; // default to local if no Firebase
  renderAvatarPickers();  
}

function authGo(mode) {  
  authMode = mode;  
  hideAllSteps();  
  if (mode === 'create') document.getElementById('authStepCreate').classList.add('active');
  else if (mode === 'join') document.getElementById('authStepJoin').classList.add('active');
  else if (mode === 'login') document.getElementById('authStepLogin').classList.add('active');
}  
  
function authBack() {  
  hideAllSteps();  
  document.getElementById('authStep1').classList.add('active');  
}  
  
function hideAllSteps() {  
  document.querySelectorAll('.auth-step').forEach(s => s.classList.remove('active'));  
}  
  
function renderAvatarPickers() {  
  ['avatarPick','avatarPickJoin'].forEach(id => {  
    const el = document.getElementById(id);  
    el.innerHTML = AVATARS.map((a,i) => `  
      <div class="avatar-opt ${i===0?'sel':''}" onclick="selectAv('${a}','${id}',this)">${a}</div>  
    `).join('');  
  });  
  state.selectedAvatar = AVATARS[0];  
}  
  
function selectAv(av, gridId, el) {  
  state.selectedAvatar = av;  
  document.querySelectorAll('#'+gridId+' .avatar-opt').forEach(e => e.classList.remove('sel'));  
  el.classList.add('sel');  
}  
  
function generateCode() {
  // Alphabet without ambiguous chars: O/0, I/1, S/5, etc.
  const chars = 'ABCDEFGHJKLMNPQRTUVWXYZ2346789';
  let code = '';
  const array = new Uint8Array(8);
  crypto.getRandomValues(array);
  for (let i = 0; i < 8; i++) {
    code += chars[array[i] % chars.length];
  }
  return code;
}

function isCodeTaken(code) {
  const homes = JSON.parse(localStorage.getItem('hogar_homes') || '{}');
  return Object.values(homes).some(h => h.code === code);
}

function generateUniqueCode() {
  let code;
  let attempts = 0;
  do {
    code = generateCode();
    attempts++;
  } while (isCodeTaken(code) && attempts < 10);
  return code;
}

function renderCodeChars(code, containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;
  el.innerHTML = code.split('').map(c =>
    `<span style="display:inline-flex;align-items:center;justify-content:center;
      width:32px;height:40px;
      background:rgba(125,249,255,0.08);
      border:1.5px solid rgba(125,249,255,0.3);
      border-radius:8px;
      font-size:18px;font-weight:800;
      font-family:'Bricolage Grotesque',sans-serif;
      color:var(--neon);
      letter-spacing:0;
      box-shadow:0 0 10px rgba(125,249,255,0.15)">${c}</span>`
  ).join('');
}  
  
async function createHome() {  
  const email = (document.getElementById('createEmail').value || '').trim().toLowerCase();
  const homeName = document.getElementById('homeName').value.trim();  
  const userName = document.getElementById('createUserName').value.trim();  
  if (!email || !homeName || !userName) { showToast('⚠️ Completa todos los campos'); return; }
  if (!email.includes('@')) { showToast('⚠️ Correo inválido'); return; }
  
  const code = generateUniqueCode();  
  const homeId = 'home_' + code;  
  const userId = 'u_' + Date.now();  
  
  const userData = { name: userName, email, avatar: state.selectedAvatar, points: 0, streak: 0, history: [], joinedAt: Date.now(), role: 'admin' };
  const homeData = { name: homeName, code, createdAt: Date.now(), ownerId: userId };  
  
  state.homeId = homeId;
  state.homeCode = code;
  state.homeName = homeName;
  state.myUserId = userId;
  state.ownerId = userId;

  if (!state.useLocalMode && window._db) {  
    try {
      await window._set(window._ref(window._db, `homes/${homeId}`), homeData);  
      await window._set(window._ref(window._db, `homes/${homeId}/users/${userId}`), userData);
    } catch(e) {
      state.useLocalMode = true;
    }
  }

  if (state.useLocalMode) {
    const homes = JSON.parse(localStorage.getItem('hogar_homes') || '{}');
    homes[homeId] = { ...homeData, users: { [userId]: userData }, tasks: {} };
    localStorage.setItem('hogar_homes', JSON.stringify(homes));
    state.users = { [userId]: userData };
    state.tasks = {};
  }

  saveSession();
  renderCodeChars(code, 'displayCodeChars');
  document.getElementById('displayCode').textContent = code;
  hideAllSteps();  
  document.getElementById('authStepCode').classList.add('active');  
}  
  
async function joinHome() {  
  const email = (document.getElementById('joinEmail').value || '').trim().toLowerCase();
  const code = document.getElementById('joinCode').value.trim().toUpperCase();  
  const userName = document.getElementById('joinUserName').value.trim();  
  if (!email || !code || !userName) { showToast('⚠️ Completa todos los campos'); return; }
  if (!email.includes('@')) { showToast('⚠️ Correo inválido'); return; }
  if (code.length < 8) { showToast('⚠️ Código de 8 caracteres'); return; }  
  
  const homeId = 'home_' + code;  
  const userId = 'u_' + Date.now();  
  const userData = { name: userName, email, avatar: state.selectedAvatar, points: 0, streak: 0, history: [], joinedAt: Date.now(), role: 'user' };

  // Try Firebase first
  if (!state.useLocalMode && window._db) {  
    try {  
      const snap = await window._get(window._ref(window._db, `homes/${homeId}`));  
      if (!snap.exists()) { showToast('❌ Código no encontrado'); return; }  
      const homeData = snap.val();  
      await window._set(window._ref(window._db, `homes/${homeId}/users/${userId}`), userData);  
      state.homeId = homeId;  
      state.homeCode = code;  
      state.homeName = homeData.name;  
      state.myUserId = userId;  
      state.ownerId = homeData.ownerId || null;  
      saveSession();  
      loadHomeData();
      return;
    } catch(e) {  
      // Fall through to local
    }  
  }

  // Local mode
  const homes = JSON.parse(localStorage.getItem('hogar_homes') || '{}');
  if (!homes[homeId]) { showToast('❌ Código no encontrado'); return; }
  const homeData = homes[homeId];
  homeData.users = homeData.users || {};
  homeData.users[userId] = userData;
  localStorage.setItem('hogar_homes', JSON.stringify(homes));

  state.useLocalMode = true;
  state.homeId = homeId;
  state.homeCode = code;
  state.homeName = homeData.name;
  state.myUserId = userId;
  state.ownerId = homeData.ownerId || null;
  state.users = homeData.users;
  state.tasks = homeData.tasks || {};
  saveSession();
  loadHomeData();
}

// ── LOGIN with email + code ──
async function loginUser() {
  const email = (document.getElementById('loginEmail').value || '').trim().toLowerCase();
  const code = document.getElementById('loginCode').value.trim().toUpperCase();
  if (!email || !code) { showToast('⚠️ Completa todos los campos'); return; }
  if (!email.includes('@')) { showToast('⚠️ Correo inválido'); return; }
  if (code.length < 8) { showToast('⚠️ Código de 8 caracteres'); return; }

  const homeId = 'home_' + code;

  // Firebase login
  if (!state.useLocalMode && window._db) {
    try {
      const snap = await window._get(window._ref(window._db, `homes/${homeId}`));
      if (!snap.exists()) { showToast('❌ Código no encontrado'); return; }
      const homeData = snap.val();
      const usersSnap = await window._get(window._ref(window._db, `homes/${homeId}/users`));
      const users = usersSnap.val() || {};
      const match = Object.entries(users).find(([, u]) => u.email === email);
      if (!match) { showToast('❌ Correo no registrado en este hogar'); return; }
      const [userId] = match;
      state.homeId = homeId;
      state.homeCode = code;
      state.homeName = homeData.name;
      state.myUserId = userId;
      state.ownerId = homeData.ownerId || null;
      saveSession();
      loadHomeData();
      return;
    } catch(e) { /* fall through */ }
  }

  // Local login
  const homes = JSON.parse(localStorage.getItem('hogar_homes') || '{}');
  if (!homes[homeId]) { showToast('❌ Código no encontrado'); return; }
  const homeData = homes[homeId];
  const users = homeData.users || {};
  const match = Object.entries(users).find(([, u]) => u.email === email);
  if (!match) { showToast('❌ Correo no registrado en este hogar'); return; }
  const [userId] = match;

  state.useLocalMode = true;
  state.homeId = homeId;
  state.homeCode = code;
  state.homeName = homeData.name;
  state.myUserId = userId;
  state.ownerId = homeData.ownerId || null;
  state.users = users;
  state.tasks = homeData.tasks || {};
  saveSession();
  loadHomeData();
}

function enterApp() {  
  loadHomeData();  
}  
  
function saveSession() {  
  localStorage.setItem('hogar_session', JSON.stringify({  
    homeId: state.homeId, homeCode: state.homeCode,  
    userId: state.myUserId, homeName: state.homeName,  
    ownerId: state.ownerId, useLocalMode: state.useLocalMode
  }));  
}  
  
function logout() {  
  localStorage.removeItem('hogar_session');  
  if (state.unsubTasks) state.unsubTasks();  
  if (state.unsubUsers) state.unsubUsers();
  // Reset state but keep hogar_homes so others can still log back in
  state = {
    homeId: null, homeCode: null, homeName: null, ownerId: null,
    myUserId: null, currentViewUser: null, users: {}, tasks: {},
    filter: 'mine', editingTaskId: null, selectedEmoji: '🧹',
    selectedAssignees: [], selectedDays: [], selectedAvatar: '👨',
    selectedCalDay: new Date().getDay(), calViewAll: false,
    unsubTasks: null, unsubUsers: null, useLocalMode: false
  };
  document.getElementById('app').style.display = 'none';
  document.getElementById('mainNav').style.display = 'none';
  renderAvatarPickers();
  hideAllSteps();
  document.getElementById('authStep1').classList.add('active');
  document.getElementById('authScreen').style.display = 'flex';
  document.getElementById('authScreen').classList.remove('hidden');
  // Clear login fields
  ['loginEmail','loginCode','createEmail','homeName','createUserName','joinEmail','joinUserName','joinCode'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
}  
  
// ══════════════════════════════════════════════════════  
// LOAD DATA (Firebase realtime)  
// ══════════════════════════════════════════════════════  
function loadHomeData() {  
  if (state.useLocalMode) {
    // Load from localStorage if we have real local data
    const homes = JSON.parse(localStorage.getItem('hogar_homes') || '{}');
    if (homes[state.homeId]) {
      const homeData = homes[state.homeId];
      state.users = homeData.users || {};
      state.tasks = homeData.tasks || {};
      if (homeData.ownerId) state.ownerId = homeData.ownerId;
    } else if (!state.users || !Object.keys(state.users).length) {
      // Fallback to demo data only if no real data
      state.users = localData.users;
      state.tasks = localData.tasks;
      state.ownerId = 'u1';
    }
    if (!state.currentViewUser) state.currentViewUser = state.myUserId;
    enterMainApp();
    return;
  }
  if (!window._db) { initLocalMode(); return; }  
  
  // Fetch home metadata (ownerId)  
  window._get(window._ref(window._db, `homes/${state.homeId}`)).then(snap => {  
    if (snap.exists()) {  
      const homeData = snap.val();  
      if (homeData.ownerId) { state.ownerId = homeData.ownerId; saveSession(); }  
    }  
  });  
  
  // Subscribe to users  
  state.unsubUsers = window._onValue(  
    window._ref(window._db, `homes/${state.homeId}/users`),  
    snap => {  
      state.users = snap.val() || {};  
      state.currentViewUser = state.myUserId;  
      refreshUI();  
    }  
  );  
  
  // Subscribe to tasks  
  state.unsubTasks = window._onValue(  
    window._ref(window._db, `homes/${state.homeId}/tasks`),  
    snap => {  
      state.tasks = snap.val() || {};  
      refreshUI();  
    }  
  );  
  
  enterMainApp();  
}  
  
function enterMainApp() {  
  document.getElementById('authScreen').classList.add('hidden');  
  document.getElementById('app').style.display = 'block';  
  document.getElementById('mainNav').style.display = 'flex';  
  if (!state.currentViewUser) state.currentViewUser = state.myUserId;  
  renderHome();  
  setupPWA();
  setTimeout(checkPendingAdmin, 600);
  setTimeout(checkRoleNotification, 800);
}  
  
function refreshUI() {  
  const active = document.querySelector('.screen.active');  
  if (!active) return;  
  const id = active.id.replace('screen-','');  
  if (id === 'home') renderHome();  
  else if (id === 'ranking') renderRanking();  
  else if (id === 'profile') renderProfile();  
  else if (id === 'manage') renderManage();  
}  
  
// ══════════════════════════════════════════════════════  
// NAV  
// ══════════════════════════════════════════════════════  
window.showScreen = function(name) {  
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));  
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));  
  document.getElementById('screen-'+name).classList.add('active');  
  document.getElementById('nav-'+name).classList.add('active');  
  if (name === 'home') renderHome();  
  else if (name === 'ranking') renderRanking();  
  else if (name === 'profile') renderProfile();  
  else if (name === 'manage') renderManage();  
};  
  
// ══════════════════════════════════════════════════════  
// HOME  
// ══════════════════════════════════════════════════════  
function renderHome() {  
  const user = state.users[state.currentViewUser] || state.users[state.myUserId];  
  if (!user) return;  
  
  // Greeting  
  const h = new Date().getHours();  
  const greet = h < 12 ? '¡Buenos días! ☀️' : h < 19 ? '¡Buenas tardes! 🌤️' : '¡Buenas noches! 🌙';  
  document.getElementById('hdrGreeting').textContent = greet;  
  document.getElementById('hdrName').textContent = user.name;  
  document.getElementById('hdrAvatar').textContent = user.avatar;  
  document.getElementById('hdrPts').textContent = user.points + ' pts';  
  document.getElementById('heroPts').textContent = user.points;  
  document.getElementById('heroStreak').textContent = `🔥 ${user.streak || 0} días de racha`;  
  
  // Donut  
  const tasks = Object.values(state.tasks);  
  const done = tasks.filter(t => t.done).length;  
  const pct = tasks.length ? Math.round(done / tasks.length * 100) : 0;  
  const circ = 2 * Math.PI * 33; // 207.3  
  setTimeout(() => {  
    document.getElementById('donutFill').style.strokeDashoffset = circ * (1 - pct/100);  
    document.getElementById('donutPct').textContent = pct + '%';  
  }, 200);  
  
  // Week bar  
  const pts = user.points;  
  const weekPct = Math.min(Math.round(pts / WEEK_GOAL * 100), 100);  
  document.getElementById('weekVal').textContent = `${pts} / ${WEEK_GOAL} pts`;  
  setTimeout(() => { document.getElementById('weekFill').style.width = weekPct + '%'; }, 300);  
  
  // User chips  
  const us = document.getElementById('userScroll');  
  us.innerHTML = Object.entries(state.users).map(([id, u]) => `  
    <div class="user-chip ${id===state.currentViewUser?'active':''}" onclick="switchViewUser('${id}')">  
      <div class="uc-avatar">${u.avatar}</div>  
      <div>  
        <div class="uc-name">${u.name}</div>  
        <div class="uc-pts">${u.points} pts</div>  
      </div>  
    </div>  
  `).join('');  
  
  renderTaskList();  
  renderWeekCalendar(state.selectedCalDay);  
}  
  
window.switchViewUser = function(id) {  
  state.currentViewUser = id;  
  renderHome();  
};  
  
window.setFilter = function(f, el) {  
  state.filter = f;  
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));  
  el.classList.add('active');  
  renderTaskList();  
};  
  
function renderTaskList() {  
  let tasks = Object.entries(state.tasks);  
  
  if (state.filter === 'pending') {  
    tasks = tasks.filter(([,t]) => !t.done);  
  } else if (state.filter === 'done') {  
    tasks = tasks.filter(([,t]) => t.done);  
  } else if (state.filter === 'mine') {  
    // Only show pending tasks assigned to this user (or general)  
    tasks = tasks.filter(([,t]) => !t.done && (!t.assignees?.length || t.assignees.includes(state.currentViewUser)));  
  }  
  // 'all' = show everything  
  
  const pending = Object.values(state.tasks).filter(t => !t.done && (!t.assignees?.length || t.assignees.includes(state.currentViewUser))).length;  
  document.getElementById('tasksLabel').textContent = state.filter === 'mine'  
    ? `Mis tareas · ${tasks.length} pendiente${tasks.length!==1?'s':''}`  
    : state.filter === 'done'  
    ? `Completadas · ${tasks.length}`  
    : `Tareas · ${pending} pendiente${pending!==1?'s':''}`;  
  
  const list = document.getElementById('taskList');  
  if (tasks.length === 0) {  
    const isAllDone = state.filter === 'mine' && Object.values(state.tasks).filter(t => !t.assignees?.length || t.assignees.includes(state.currentViewUser)).every(t => t.done);  
    list.innerHTML = `<div class="empty-state">  
      <div class="empty-icon">${isAllDone ? '🏆' : '✅'}</div>  
      <div class="empty-title">${isAllDone ? '¡Todo completado!' : 'Sin tareas aquí'}</div>  
      <div class="empty-sub">${isAllDone ? '¡Eres increíble! No quedan pendientes.' : 'Cambia el filtro o crea nuevas tareas'}</div>  
    </div>`;  
    return;  
  }  
  
  // For 'all': pending first, then done  
  if (state.filter === 'all') tasks.sort(([,a],[,b]) => (a.done?1:0)-(b.done?1:0));  
  
  list.innerHTML = tasks.map(([id, t]) => {  
    const assigneeAv = t.assignees?.length  
      ? `<div class="task-assignees">${t.assignees.slice(0,3).map(uid => `<div class="t-av">${state.users[uid]?.avatar||'?'}</div>`).join('')}</div>`  
      : `<span style="font-size:11px;color:var(--text3)">General</span>`;  
  
    const iconBgs = {  
      '🍽️':'rgba(251,191,36,0.12)','🧹':'rgba(52,238,154,0.12)','🚿':'rgba(96,165,250,0.12)',  
      '🗑️':'rgba(148,163,184,0.12)','🧺':'rgba(167,139,250,0.12)','🪟':'rgba(125,249,255,0.12)',  
      '🛒':'rgba(251,146,60,0.12)','🧽':'rgba(52,238,154,0.12)'  
    };  
    const bg = iconBgs[t.icon] || 'rgba(255,255,255,0.06)';  
  
    // Can this user interact with the task?  
    const canToggle = !t.assignees?.length || t.assignees.includes(state.myUserId);  
  
    return `  
    <div class="task-card ${t.done?'done':''} ${!canToggle?'locked-card':''}" id="tc-${id}" onclick="toggleTask('${id}', event)">  
      <div class="task-icon-wrap" style="background:${bg}">  
        ${t.icon}  
        <div class="task-icon-glow" style="background:${bg};filter:blur(8px)"></div>  
      </div>  
      <div class="task-body">  
        <div class="task-name">${t.name}</div>  
        <div class="task-meta">  
          <span class="task-pts-badge">${t.done?'✓':'+'}${t.pts}</span>  
          <span class="task-freq" title="${t.days?.length?t.days.map(d=>DAY_NAMES[d]).join(', '):''}">↻ ${formatDays(t.days, t.freq)}</span>  
          ${assigneeAv}  
        </div>  
      </div>  
      <div class="task-check ${t.done?'done':''} ${!canToggle?'locked-check':''}" id="chk-${id}">  
        <span class="check-icon">${t.done ? '✓' : (!canToggle ? '🔒' : '')}</span>  
      </div>  
    </div>`;  
  }).join('');  
}  
  
window.toggleTask = async function(id, e) {  
  const task = state.tasks[id];  
  if (!task) return;  
  const user = state.users[state.currentViewUser];  
  if (!user) return;  
  
  // ── Permission: only assignees (or general tasks) can toggle ──  
  const isAssigned = !task.assignees?.length || task.assignees.includes(state.myUserId);  
  if (!isAssigned) {  
    // Wiggle the lock icon to signal no permission  
    const card = document.getElementById('tc-' + id);  
    if (card) {  
      card.style.animation = 'none';  
      card.classList.add('uncompleting');  
      setTimeout(() => card.classList.remove('uncompleting'), 450);  
    }  
    showToast('🔒 Esta tarea está asignada a otra persona');  
    return;  
  }  
  
  const newDone = !task.done;  
  const card = document.getElementById('tc-' + id);  
  const checkBtn = document.getElementById('chk-' + id);  
  
  if (newDone) {  
    // ── COMPLETE: run animation then update state ──  
    if (card) {  
      // 1. Flash the card green  
      const flash = document.createElement('div');  
      flash.className = 'task-flash';  
      card.appendChild(flash);  
  
      // 2. Morph the check button  
      if (checkBtn) {  
        checkBtn.classList.add('done', 'completing-check');  
        checkBtn.querySelector('.check-icon').textContent = '✓';  
        setTimeout(() => checkBtn.classList.remove('completing-check'), 500);  
      }  
  
      // 3. Float points label  
      const rect = card.getBoundingClientRect();  
      const ptFloat = document.createElement('div');  
      ptFloat.className = 'pts-float';  
      ptFloat.textContent = `+${task.pts} pts`;  
      ptFloat.style.left = (rect.right - 80) + 'px';  
      ptFloat.style.top = (rect.top + rect.height / 2) + 'px';  
      document.body.appendChild(ptFloat);  
      setTimeout(() => ptFloat.remove(), 1100);  
  
      // 4. Burst particles  
      triggerBurst(e);  
  
      // 5. If filter hides completed tasks, slide card out after brief pause  
      const filterHidesDone = state.filter === 'mine';  
      if (filterHidesDone) {  
        setTimeout(() => {  
          if (card) card.classList.add('completing');  
        }, 300);  
        // Update state after animation ends  
        setTimeout(() => {  
          _applyComplete(id, task, user, newDone);  
        }, 850);  
      } else {  
        // In 'all' or 'done' view: update immediately, card stays visible as done  
        setTimeout(() => { _applyComplete(id, task, user, newDone); }, 350);  
      }  
    }  
    showToast(`🎉 +${task.pts} pts para ${user.name}!`);  
  
  } else {  
    // ── UNCOMPLETE: animated ──  
    if (card) {  
      // Red flash overlay  
      const flashRed = document.createElement('div');  
      flashRed.className = 'task-flash-red';  
      card.appendChild(flashRed);  
      setTimeout(() => flashRed.remove(), 500);  
  
      // Shake the card  
      card.classList.add('uncompleting');  
      setTimeout(() => card.classList.remove('uncompleting'), 500);  
  
      // Check button morph back  
      if (checkBtn) {  
        checkBtn.classList.add('completing-check');  
        setTimeout(() => {  
          checkBtn.classList.remove('done', 'completing-check');  
          checkBtn.querySelector('.check-icon').textContent = '';  
        }, 200);  
      }  
  
      // Float pts downward in red  
      const rect = card.getBoundingClientRect();  
      const ptFloat = document.createElement('div');  
      ptFloat.className = 'pts-float-down';  
      ptFloat.textContent = `−${task.pts} pts`;  
      ptFloat.style.left = (rect.right - 80) + 'px';  
      ptFloat.style.top = (rect.top + rect.height / 2) + 'px';  
      document.body.appendChild(ptFloat);  
      setTimeout(() => ptFloat.remove(), 1000);  
    }  
  
    setTimeout(() => {  
      _applyComplete(id, task, user, newDone);  
    }, 300);  
    showToast('↩️ Tarea desmarcada');  
  }  
};  
  
async function _applyComplete(id, task, user, newDone) {  
  if (state.useLocalMode) {  
    if (newDone) {  
      task.done = true;  
      task.completedBy = state.currentViewUser;  
      task.completedAt = Date.now();  
      user.points += task.pts;  
      if (!user.history) user.history = [];  
      user.history.unshift({ taskName: task.name, pts: task.pts, icon: task.icon, date: Date.now() });  
    } else {  
      task.done = false;  
      task.completedBy = null;  
      user.points = Math.max(0, user.points - task.pts);  
    }  
    persistLocalHome();
    renderHome();  
    return;  
  }  
  
  // Firebase mode  
  const uid = state.currentViewUser;  
  const taskRef = window._ref(window._db, `homes/${state.homeId}/tasks/${id}`);  
  const userRef = window._ref(window._db, `homes/${state.homeId}/users/${uid}`);  
  const snap = await window._get(userRef);  
  const userData = snap.val() || {};  
  const currentPts = userData.points || 0;  
  
  if (newDone) {  
    const histRef = window._push(window._ref(window._db, `homes/${state.homeId}/users/${uid}/history`));  
    await window._set(histRef, { taskName: task.name, pts: task.pts, icon: task.icon, date: Date.now() });  
    await window._update(taskRef, { done: true, completedBy: uid, completedAt: Date.now() });  
    await window._update(userRef, { points: currentPts + task.pts });  
  } else {  
    await window._update(taskRef, { done: false, completedBy: null });  
    await window._update(userRef, { points: Math.max(0, currentPts - task.pts) });  
  }  
}  
  
// ══════════════════════════════════════════════════════  
// RANKING  
// ══════════════════════════════════════════════════════  
function renderRanking() {  
  const sorted = Object.entries(state.users).sort(([,a],[,b]) => b.points - a.points);  
  if (!sorted.length) return;  
  
  document.getElementById('rankSub').textContent = `${state.homeName || 'Hogar'} · Semana actual`;  
  
  // Star  
  const [starId, star] = sorted[0];  
  document.getElementById('starName').textContent = star.avatar + ' ' + star.name;  
  const hist = star.history ? (Array.isArray(star.history) ? star.history : Object.values(star.history)) : [];  
  document.getElementById('starPts').textContent = `${star.points} puntos · ${hist.length} tareas`;  
  
  // Podium  
  const pod = document.getElementById('podium');  
  const top = sorted.slice(0,3);  
  const podOrder = top.length >= 2 ? [top[1], top[0], top[2]].filter(Boolean) : top;  
  const podClasses = top.length >= 2 ? ['p2','p1','p3'] : ['p1','p2','p3'];  
  const podHeights = top.length >= 2 ? [44,60,32] : [60,44,32];  
  pod.innerHTML = podOrder.map(([,u], i) => `  
    <div class="podium-item ${podClasses[i]}" style="animation-delay:${[0.1,0,0.2][i]}s">  
      ${podClasses[i]==='p1' ? '<div class="pod-crown">👑</div>' : ''}  
      <div class="pod-av">${u.avatar}</div>  
      <div class="pod-name">${u.name}</div>  
      <div class="pod-pts">${u.points} pts</div>  
      <div class="pod-block" style="height:${podHeights[i]}px">${['🥈','🥇','🥉'][i]}</div>  
    </div>  
  `).join('');  
  
  // Rest  
  const listEl = document.getElementById('rankList');  
  const rest = sorted.slice(3);  
  listEl.innerHTML = rest.length ? rest.map(([,u], i) => `  
    <div class="rank-row" style="animation-delay:${i*0.05}s">  
      <div class="rank-pos">${i+4}</div>  
      <div class="rank-av">${u.avatar}</div>  
      <div class="rank-info">  
        <div class="rank-name">${u.name}</div>  
        <div class="rank-meta">${(Array.isArray(u.history)?u.history:Object.values(u.history||{})).length} tareas · 🔥${u.streak||0}</div>  
      </div>  
      <div class="rank-score">${u.points}</div>  
    </div>  
  `).join('') : '';  
}  
  
// ══════════════════════════════════════════════════════  
// PROFILE  
// ══════════════════════════════════════════════════════  
function renderProfile() {  
  const user = state.users[state.myUserId];  
  if (!user) return;  
  
  document.getElementById('profAv').textContent = user.avatar;  
  document.getElementById('profName').textContent = user.name;  
  document.getElementById('profRole').textContent = '🏠 ' + (state.homeName || 'Hogar');

  // Email
  const emailEl = document.getElementById('profEmail');
  if (emailEl) emailEl.textContent = user.email || '';

  // Role badges
  const isAdmin = state.myUserId === state.ownerId;
  const adminBadge = document.getElementById('adminBadgeProf');
  const userBadge = document.getElementById('userBadgeProf');
  if (adminBadge) adminBadge.style.display = isAdmin ? 'inline-block' : 'none';
  if (userBadge) userBadge.style.display = !isAdmin ? 'inline-block' : 'none';

  document.getElementById('sPoints').textContent = user.points;  
  
  const hist = user.history  
    ? (Array.isArray(user.history) ? user.history : Object.values(user.history))  
    : [];  
  document.getElementById('sDone').textContent = hist.length;  
  document.getElementById('sStreak').textContent = (user.streak || 0) + '🔥';  
  
  const hl = document.getElementById('histList');  
  if (!hist.length) {  
    hl.innerHTML = `<div class="empty-state"><div class="empty-icon">📭</div><div class="empty-title">Sin historial aún</div><div class="empty-sub">¡Completa tareas para ver tu progreso!</div></div>`;  
    return;  
  }  
  hl.innerHTML = hist.slice(0,12).map((h,i) => `  
    <div class="hist-item" style="animation-delay:${i*0.04}s">  
      <div class="hist-ico">${h.icon||'✅'}</div>  
      <div class="hist-info">  
        <div class="hist-name">${h.taskName}</div>  
        <div class="hist-date">${relTime(h.date)}</div>  
      </div>  
      <div class="hist-pts">+${h.pts}</div>  
    </div>  
  `).join('');  
}  
  
// ══════════════════════════════════════════════════════  
// MANAGE  
// ══════════════════════════════════════════════════════  
function renderManage() {  
  const isAdmin = state.myUserId === state.ownerId;  
  const ml = document.getElementById('manageList');  
  
  // Home code card (always shown)
  const codeCard = `
    <div style="background:linear-gradient(135deg,rgba(125,249,255,0.06),rgba(167,139,250,0.04));border:1.5px solid rgba(125,249,255,0.2);border-radius:var(--r-lg);padding:20px;margin-bottom:14px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
        <div style="font-size:22px">🏠</div>
        <div>
          <div style="font-size:15px;font-weight:800;color:var(--text)">${state.homeName || 'Mi Hogar'}</div>
          <div style="font-size:11px;color:var(--text3);margin-top:1px">Código único de acceso al grupo</div>
        </div>
      </div>
      <div id="manageCodeChars" style="display:flex;gap:4px;justify-content:center;flex-wrap:wrap;margin-bottom:14px"></div>
      <div style="font-size:11px;color:var(--text3);text-align:center;margin-bottom:14px">
        8 caracteres · generado aleatoriamente · comparte con tu familia
      </div>
      <div style="display:flex;gap:8px">
        <button onclick="copyCode()"
          style="flex:1;padding:11px;background:rgba(125,249,255,0.1);border:1.5px solid rgba(125,249,255,0.25);border-radius:var(--r-sm);color:var(--neon);font-size:13px;font-weight:700;cursor:pointer;font-family:'Bricolage Grotesque',sans-serif;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s">
          📋 Copiar código
        </button>
        <button onclick="shareCode()"
          style="flex:1;padding:11px;background:rgba(167,139,250,0.1);border:1.5px solid rgba(167,139,250,0.25);border-radius:var(--r-sm);color:var(--neon2);font-size:13px;font-weight:700;cursor:pointer;font-family:'Bricolage Grotesque',sans-serif;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s">
          🔗 Compartir
        </button>
      </div>
    </div>`;  
  
  // Admin badge  
  const adminCard = isAdmin ? `  
    <div style="background:rgba(255,196,83,0.07);border:1px solid rgba(255,196,83,0.2);border-radius:var(--r-md);padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:10px;font-size:13px;color:var(--amber)">  
      <span style="font-size:18px">👑</span>  
      <span style="flex:1">Eres el <strong>administrador</strong> — puedes modificar puntos, crear y eliminar tareas</span>
      <button onclick="openTransferModal()" style="background:rgba(255,196,83,0.15);border:1px solid rgba(255,196,83,0.3);border-radius:8px;padding:6px 10px;color:var(--amber);font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;font-family:'Instrument Sans',sans-serif">Roles 👥</button>
    </div>` : `  
    <div style="background:rgba(148,163,184,0.07);border:1px solid rgba(148,163,184,0.15);border-radius:var(--r-md);padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:10px;font-size:13px;color:var(--text2)">  
      <span style="font-size:18px">👤</span>  
      <span>Solo el administrador puede modificar los <strong>puntos</strong> de las tareas</span>  
    </div>`;

  // Members section
  const membersList = Object.entries(state.users).map(([uid, u]) => {
    const isOwner = uid === state.ownerId;
    const userRole = isOwner ? 'admin' : (u.role || 'user');
    const roleBadge = userRole === 'admin'
      ? `<span class="role-badge-admin">👑 Administrador</span>`
      : `<span class="role-badge-user">👤 Usuario</span>`;
    return `
    <div style="display:flex;align-items:center;gap:12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r-md);padding:12px 14px;margin-bottom:8px">
      <div style="font-size:26px;width:40px;height:40px;background:var(--surface2);border-radius:50%;display:flex;align-items:center;justify-content:center">${u.avatar}</div>
      <div style="flex:1">
        <div style="font-size:14px;font-weight:600">${u.name}${uid === state.myUserId ? ' <span style="font-size:11px;color:var(--text3)">(tú)</span>' : ''}</div>
        <div style="font-size:12px;color:var(--text3);margin-top:3px">${u.email || ''}</div>
        <div style="margin-top:5px">${roleBadge}</div>
      </div>
    </div>`;
  }).join('');

  const membersSection = `
    <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;margin-top:4px">Miembros del hogar</div>
    ${membersList}
    <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;margin-top:20px">Tareas</div>
  `;
  
  const tasks = Object.entries(state.tasks);  
  const taskList = tasks.length ? tasks.map(([id,t]) => `  
    <div class="manage-item">  
      <div class="mi-icon">${t.icon}</div>  
      <div class="mi-info">  
        <div class="mi-name">${t.name}</div>  
        <div class="mi-meta">  
          ${isAdmin ? `<span style="color:var(--amber);font-weight:700">${t.pts} pts</span>` : `${t.pts} pts`}  
          · ${formatDays(t.days, t.freq)}  
          · ${t.assignees?.length ? t.assignees.map(u=>state.users[u]?.avatar||'?').join('') : 'General'}  
        </div>  
      </div>  
      <div class="mi-actions">  
        <button class="mi-btn mi-edit" onclick="editTask('${id}')">✏️</button>  
        ${isAdmin ? `<button class="mi-btn mi-del" onclick="deleteTask('${id}')">🗑️</button>` : ''}  
      </div>  
    </div>  
  `).join('') : `<div class="empty-state"><div class="empty-icon">📋</div><div class="empty-title">Sin tareas</div><div class="empty-sub">Crea la primera tarea del hogar</div></div>`;  
  
  ml.innerHTML = codeCard + adminCard + membersSection + taskList;
  renderCodeChars(state.homeCode || '——', 'manageCodeChars');
}  
  
window.copyCode = function() {  
  const code = state.homeCode || '';  
  if (navigator.clipboard) {  
    navigator.clipboard.writeText(code).then(() => showToast('📋 Código copiado: ' + code));  
  } else {  
    showToast('Código: ' + code);  
  }  
};

window.shareCode = function() {
  const code = state.homeCode || '';
  const homeName = state.homeName || 'mi hogar';
  const text = `¡Únete a ${homeName} en Hogar! Usa el código: ${code}`;
  if (navigator.share) {
    navigator.share({ title: 'Hogar ✦', text }).catch(() => {});
  } else if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => showToast('🔗 Mensaje copiado al portapapeles'));
  } else {
    showToast('Código: ' + code);
  }
};

window.openTransferModal = function() {
  const list = document.getElementById('transferUserList');
  const others = Object.entries(state.users).filter(([uid]) => uid !== state.myUserId);
  if (!others.length) {
    showToast('No hay otros miembros en el hogar');
    return;
  }
  list.innerHTML = others.map(([uid, u]) => {
    const isAdmin = uid === state.ownerId;
    const currentRole = isAdmin ? 'admin' : (u.role || 'user');
    return `
    <div style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-md);padding:14px;margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <div style="font-size:28px;width:44px;height:44px;background:var(--surface2);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0">${u.avatar}</div>
        <div>
          <div style="font-size:15px;font-weight:700">${u.name}</div>
          <div style="font-size:12px;color:var(--text3);margin-top:2px">${u.email || ''} · ${u.points} pts</div>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button onclick="setUserRole('${uid}','admin')"
          style="flex:1;padding:9px 6px;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Bricolage Grotesque',sans-serif;transition:all 0.2s;
                 background:${currentRole==='admin'?'rgba(255,196,83,0.25)':'rgba(255,196,83,0.07)'};
                 border:1.5px solid ${currentRole==='admin'?'rgba(255,196,83,0.6)':'rgba(255,196,83,0.2)'};
                 color:var(--amber)">
          👑 Admin
        </button>
        <button onclick="setUserRole('${uid}','user')"
          style="flex:1;padding:9px 6px;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Bricolage Grotesque',sans-serif;transition:all 0.2s;
                 background:${currentRole==='user'?'rgba(148,163,184,0.2)':'rgba(148,163,184,0.06)'};
                 border:1.5px solid ${currentRole==='user'?'rgba(148,163,184,0.5)':'rgba(148,163,184,0.15)'};
                 color:var(--text2)">
          👤 Usuario
        </button>
      </div>
    </div>`;
  }).join('');
  document.getElementById('transferAdminModal').classList.add('open');
};

window.closeTransferModal = function() {
  document.getElementById('transferAdminModal').classList.remove('open');
};

window.setUserRole = async function(uid, newRole) {
  const user = state.users[uid];
  if (!user) return;
  const prevRole = uid === state.ownerId ? 'admin' : (user.role || 'user');
  if (prevRole === newRole) return; // No change

  // Apply role change immediately
  user.role = newRole;
  state.users[uid] = user;

  // If promoting to admin, they become co-admin (we keep ownerId as current admin)
  // If demoting from admin-level, just update role
  // Store the role-change notification so they see it on next login
  const notifKey = `hogar_role_notif_${state.homeId}_${uid}`;
  const myName = state.users[state.myUserId]?.name || 'El administrador';
  localStorage.setItem(notifKey, JSON.stringify({
    newRole,
    fromName: myName,
    ts: Date.now()
  }));

  persistLocalHome();

  if (!state.useLocalMode && window._db) {
    try {
      await window._update(window._ref(window._db, `homes/${state.homeId}/users/${uid}`), { role: newRole });
    } catch(e) {}
  }

  const roleLabel = newRole === 'admin' ? '👑 Administrador' : '👤 Usuario';
  showToast(`${user.name} ahora es ${roleLabel}`);

  // Refresh modal in place
  openTransferModal();
  // Refresh manage list
  renderManage();
};

function checkRoleNotification() {
  const notifKey = `hogar_role_notif_${state.homeId}_${state.myUserId}`;
  const raw = localStorage.getItem(notifKey);
  if (!raw) return;
  try {
    const notif = JSON.parse(raw);
    // Only show if recent (last 24h)
    if (Date.now() - notif.ts < 86400000) {
      const roleLabel = notif.newRole === 'admin' ? '👑 Administrador' : '👤 Usuario';
      setTimeout(() => showToast(`${notif.fromName} te asignó el rol: ${roleLabel}`), 1000);
    }
    localStorage.removeItem(notifKey);
  } catch(e) {}
}

// Keep these stubs so nothing breaks if called
function checkPendingAdmin() {}
window.acceptAdminRole = function() {};
window.declineAdminRole = function() {
  document.getElementById('adminPendingBanner').style.display = 'none';
};

document.getElementById('transferAdminModal').addEventListener('click', e => {
  if (e.target === document.getElementById('transferAdminModal')) closeTransferModal();
});  
  
window.editTask = function(id) {  
  state.editingTaskId = id;  
  openTaskModal(state.tasks[id]);  
};  
  
window.deleteTask = async function(id) {  
  if (state.useLocalMode) {  
    delete state.tasks[id];
    persistLocalHome();
    showToast('🗑️ Tarea eliminada');  
    renderManage(); return;  
  }  
  await window._remove(window._ref(window._db, `homes/${state.homeId}/tasks/${id}`));  
  showToast('🗑️ Tarea eliminada');  
};  
  
// ══════════════════════════════════════════════════════  
// TASK MODAL  
// ══════════════════════════════════════════════════════  
window.openTaskModal = function(task) {  
  state.editingTaskId = task ? state.editingTaskId : null;  
  state.selectedEmoji = task?.icon || '🧹';  
  state.selectedAssignees = task?.assignees ? [...task.assignees] : [];  
  state.selectedDays = task?.days ? [...task.days] : (task?.freq === 'Diaria' ? [0,1,2,3,4,5,6] : [1]);  
  
  document.getElementById('modalTitle').textContent = task ? '✎ Editar tarea' : '✦ Nueva tarea';  
  document.getElementById('fName').value = task?.name || '';  
  document.getElementById('fDesc').value = task?.desc || '';  
  document.getElementById('fPts').value = task?.pts || '';  
  document.getElementById('fFreq').value = task?.freq || 'Diaria';  
  
  // Admin-only: points field  
  const isAdmin = state.myUserId === state.ownerId;  
  const ptsInput = document.getElementById('fPts');  
  const ptsBadge = document.getElementById('ptsAdminBadge');  
  if (isAdmin) {  
    ptsInput.disabled = false;  
    ptsInput.style.opacity = '1';  
    ptsInput.style.cursor = 'text';  
    if (ptsBadge) ptsBadge.style.display = 'none';  
  } else {  
    ptsInput.disabled = true;  
    ptsInput.style.opacity = '0.45';  
    ptsInput.style.cursor = 'not-allowed';  
    if (ptsBadge) ptsBadge.style.display = 'inline';  
  }  
  
  // Day picker  
  const freq = task?.freq || 'Diaria';  
  const wrap = document.getElementById('dayPickerWrap');  
  if (freq === 'Quincenal' || freq === 'Mensual') {  
    wrap.style.display = 'none';  
  } else {  
    wrap.style.display = 'block';  
    renderDayPicker(state.selectedDays);  
  }  
  
  // Emoji  
  document.getElementById('emojiPick').innerHTML = EMOJIS.map(e => `  
    <div class="ep-btn ${e===state.selectedEmoji?'sel':''}" onclick="selEmoji('${e}',this)">${e}</div>  
  `).join('');  
  
  // Assign  
  const ag = document.getElementById('assignGrid');  
  ag.innerHTML = `  
    <div class="assign-item ${state.selectedAssignees.length===0?'sel':''}" onclick="selGeneral(this)">  
      <div class="ai-av">👥</div>  
      <div><div class="ai-name">General</div><div class="ai-pts">Todos</div></div>  
    </div>  
  ` + Object.entries(state.users).map(([id,u]) => `  
    <div class="assign-item ${state.selectedAssignees.includes(id)?'sel':''}" onclick="selUser('${id}',this)">  
      <div class="ai-av">${u.avatar}</div>  
      <div><div class="ai-name">${u.name}</div><div class="ai-pts">${u.points} pts</div></div>  
    </div>  
  `).join('');  
  
  document.getElementById('taskModal').classList.add('open');  
};  
  
window.selEmoji = function(e, el) {  
  state.selectedEmoji = e;  
  document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('sel'));  
  el.classList.add('sel');  
};  
  
window.selGeneral = function(el) {  
  state.selectedAssignees = [];  
  document.querySelectorAll('.assign-item').forEach(i => i.classList.remove('sel'));  
  el.classList.add('sel');  
};  
  
window.selUser = function(id, el) {  
  const idx = state.selectedAssignees.indexOf(id);  
  if (idx >= 0) state.selectedAssignees.splice(idx, 1);  
  else state.selectedAssignees.push(id);  
  // Deselect "General"  
  const items = document.querySelectorAll('.assign-item');  
  items[0].classList.toggle('sel', state.selectedAssignees.length === 0);  
  el.classList.toggle('sel', state.selectedAssignees.includes(id));  
};  
  
window.saveTask = async function() {  
  const name = document.getElementById('fName').value.trim();  
  if (!name) { showToast('⚠️ Escribe el nombre'); return; }  
  
  const isAdmin = state.myUserId === state.ownerId;  
  const existingTask = state.editingTaskId ? state.tasks[state.editingTaskId] : null;  
  // Non-admins keep the existing pts; only admins can change them  
  const pts = isAdmin  
    ? (parseInt(document.getElementById('fPts').value) || 20)  
    : (existingTask?.pts || 20);  
  
  const taskData = {  
    name, pts,  
    desc: document.getElementById('fDesc').value.trim(),  
    freq: document.getElementById('fFreq').value,  
    days: state.selectedDays.length ? [...state.selectedDays] : [0,1,2,3,4,5,6],  
    icon: state.selectedEmoji,  
    assignees: state.selectedAssignees.length ? state.selectedAssignees : [],  
    done: false  
  };  
  
  if (state.useLocalMode) {  
    const id = state.editingTaskId || ('t' + Date.now());  
    if (state.editingTaskId) Object.assign(state.tasks[id], taskData);  
    else state.tasks[id] = taskData;
    persistLocalHome();
    closeModal();  
    showToast(state.editingTaskId ? '✅ Tarea actualizada' : '✅ Tarea creada');  
    renderHome(); renderManage(); return;  
  }  
  
  if (state.editingTaskId) {  
    await window._update(window._ref(window._db, `homes/${state.homeId}/tasks/${state.editingTaskId}`), taskData);  
    showToast('✅ Tarea actualizada');  
  } else {  
    await window._push(window._ref(window._db, `homes/${state.homeId}/tasks`), taskData);  
    showToast('✅ Tarea creada');  
  }  
  closeModal();  
};  
  
window.closeModal = function() {  
  document.getElementById('taskModal').classList.remove('open');  
  state.editingTaskId = null;  
};  
  
document.getElementById('taskModal').addEventListener('click', e => {  
  if (e.target === document.getElementById('taskModal')) closeModal();  
});  
  
// ══════════════════════════════════════════════════════  
// WEEKLY CALENDAR  
// ══════════════════════════════════════════════════════  
const DAY_NAMES = ['Do','Lu','Ma','Mi','Ju','Vi','Sá'];  
const DAY_FULL  = ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];  
const DOT_COLORS = ['#7DF9FF','#34EE9A','#A78BFA','#FFC453','#FF6B8A','#60A5FA','#F9A8D4'];  
  
function getWeekDates() {  
  const today = new Date();  
  const dow = today.getDay(); // 0=Sun  
  const monday = new Date(today); monday.setDate(today.getDate() - dow);  
  return Array.from({length:7}, (_,i) => { const d = new Date(monday); d.setDate(monday.getDate()+i); return d; });  
}  
  
function taskMatchesDay(task, dayOfWeek) {  
  if (!task.days || task.days.length === 0) {  
    // Legacy: if Diaria no days set, match all  
    return task.freq === 'Diaria';  
  }  
  return task.days.includes(dayOfWeek);  
}  
  
function renderWeekCalendar(selectedDay) {  
  if (selectedDay === undefined) selectedDay = new Date().getDay();  
  state.selectedCalDay = selectedDay;  
  
  const weekDates = getWeekDates();  
  const today = new Date().getDay();  
  const uid = state.currentViewUser || state.myUserId;  
  const allTasks = Object.entries(state.tasks);  
  
  // Days row — just the 7 column selectors  
  const row = document.getElementById('wcDaysRow');  
  row.innerHTML = weekDates.map((date) => {  
    const dow = date.getDay();  
    const dayTasks = allTasks.filter(([,t]) => {  
      const matchesUser = !t.assignees?.length || t.assignees.includes(uid);  
      return taskMatchesDay(t, dow) && matchesUser;  
    });  
    const isToday = dow === today;  
    const isSel = dow === selectedDay;  
    const dotColors = dayTasks.slice(0, 4).map((_, idx) => DOT_COLORS[idx % DOT_COLORS.length]);  
  
    return `  
    <div class="wc-day-col ${isToday ? 'today' : ''} ${isSel && !isToday ? 'selected-day' : ''} ${!isToday && !isSel ? 'other-day' : ''}"  
         onclick="selectCalDay(${dow})" style="${isSel && !isToday ? 'opacity:1' : ''}">  
      <div class="wc-day-label">${DAY_NAMES[dow]}</div>  
      <div class="wc-day-num">${date.getDate()}</div>  
      <div class="wc-task-dots">  
        ${dotColors.map(c => `<div class="wc-dot" style="background:${c}"></div>`).join('')}  
        ${dayTasks.length > 4 ? `<div style="font-size:8px;color:var(--text3)">+${dayTasks.length - 4}</div>` : ''}  
      </div>  
    </div>`;  
  }).join('');  
  
  // Toggle button label  
  const btn = document.getElementById('wcToggleBtn');  
  if (btn) btn.textContent = state.calViewAll ? 'Solo hoy' : 'Ver semana';  
  
  // Render accordion in detail panel  
  renderCalAccordion(uid, allTasks, selectedDay);  
}  
  
function renderCalAccordion(uid, allTasks, openDay) {  
  const det = document.getElementById('wcDetail');  
  const today = new Date().getDay();  
  const weekDates = getWeekDates();  
  
  // If "ver semana" mode: show all 7 days; otherwise just the selected day  
  const daysToShow = state.calViewAll  
    ? weekDates.map(d => d.getDay())  
    : [openDay];  
  
  if (!daysToShow.length) { det.innerHTML = ''; return; }  
  
  det.innerHTML = daysToShow.map((dow, idx) => {  
    const tasks = allTasks.filter(([, t]) => {  
      const matchesUser = !t.assignees?.length || t.assignees.includes(uid);  
      return taskMatchesDay(t, dow) && matchesUser;  
    });  
  
    const isToday = dow === today;  
    const pending = tasks.filter(([, t]) => !t.done).length;  
    const dayLabel = isToday ? `Hoy · ${DAY_FULL[dow]}` : DAY_FULL[dow];  
  
    // Decide count badge text & class  
    let countClass = 'empty', countText = 'Sin tareas';  
    if (tasks.length > 0) {  
      if (pending === 0) { countClass = 'all-done'; countText = '✓ Todo listo'; }  
      else { countClass = ''; countText = `${pending} pendiente${pending !== 1 ? 's' : ''}`; }  
    }  
  
    // All accordions start closed by default
    const isOpen = false;  
  
    const chipsHtml = tasks.length === 0  
      ? `<div class="wc-empty-day">🌿 Sin tareas</div>`  
      : tasks.map(([tid, t], ci) => {
          const canToggle = !t.assignees?.length || t.assignees.includes(state.myUserId);
          return `
          <div class="wc-task-chip ${t.done ? 'done-chip' : ''} ${!canToggle ? 'locked-chip' : ''}"
               style="animation-delay:${ci * 0.04}s"
               onclick="toggleCalChip('${tid}', this, event)">
            <div class="wc-chip-icon">${t.icon}</div>
            <div class="wc-chip-name">${t.name}</div>
            <div class="wc-chip-pts">${t.done ? `<span style="color:var(--green)">✓</span>` : `+${t.pts}`}</div>
            ${!canToggle ? `<div class="wc-chip-done" style="color:var(--text3)">🔒</div>` : ''}
          </div>`;
        }).join('');  
  
    return `  
      <div class="wc-accord ${isOpen ? 'open' : ''}" id="wca-${dow}">  
        <div class="wc-accord-header" onclick="toggleAccord(${dow})">  
          <div class="wc-accord-day ${isToday ? 'today-label' : ''}">${dayLabel}</div>  
          <div class="wc-accord-meta">  
            <span class="wc-accord-count ${countClass}">${countText}</span>  
            <span class="wc-accord-arrow">▾</span>  
          </div>  
        </div>  
        <div class="wc-accord-body">${chipsHtml}</div>  
      </div>`;  
  }).join('');  
}  
  
window.selectCalDay = function(dow) {  
  state.calViewAll = false;  
  const btn = document.getElementById('wcToggleBtn');  
  if (btn) btn.textContent = 'Ver semana';  
  renderWeekCalendar(dow);  
};  
  
window.toggleAccord = function(dow) {  
  const el = document.getElementById('wca-' + dow);  
  if (el) el.classList.toggle('open');  
};  
  
window.toggleCalView = function() {  
  state.calViewAll = !state.calViewAll;  
  const btn = document.getElementById('wcToggleBtn');  
  if (btn) btn.textContent = state.calViewAll ? 'Solo hoy' : 'Ver semana';  
  const uid = state.currentViewUser || state.myUserId;  
  renderCalAccordion(uid, Object.entries(state.tasks), state.selectedCalDay);  
};

// ══════════════════════════════════════════════════════
// CALENDAR CHIP TOGGLE
// ══════════════════════════════════════════════════════
window.toggleCalChip = async function(id, chipEl, e) {
  const task = state.tasks[id];
  if (!task) return;

  // Permission: only assignees (or general tasks)
  const canToggle = !task.assignees?.length || task.assignees.includes(state.myUserId);
  if (!canToggle) {
    chipEl.classList.add('chip-uncompleting');
    setTimeout(() => chipEl.classList.remove('chip-uncompleting'), 500);
    showToast('🔒 Esta tarea está asignada a otra persona');
    return;
  }

  const user = state.users[state.myUserId];
  if (!user) return;

  const newDone = !task.done;

  if (newDone) {
    // Complete animation: flash green + pts float
    chipEl.classList.add('chip-completing');
    setTimeout(() => chipEl.classList.remove('chip-completing'), 600);

    const rect = chipEl.getBoundingClientRect();
    const ptFloat = document.createElement('div');
    ptFloat.className = 'pts-float';
    ptFloat.textContent = `+${task.pts} pts`;
    ptFloat.style.left = (rect.right - 70) + 'px';
    ptFloat.style.top = (rect.top + rect.height / 2) + 'px';
    document.body.appendChild(ptFloat);
    triggerBurst(e);
    setTimeout(() => ptFloat.remove(), 1100);

    showToast(`🎉 +${task.pts} pts para ${user.name}!`);
  } else {
    // Uncomplete animation: shake + red flash + pts float down
    chipEl.classList.add('chip-uncompleting');
    setTimeout(() => chipEl.classList.remove('chip-uncompleting'), 500);

    const rect = chipEl.getBoundingClientRect();
    const ptFloat = document.createElement('div');
    ptFloat.className = 'pts-float-down';
    ptFloat.textContent = `−${task.pts} pts`;
    ptFloat.style.left = (rect.right - 70) + 'px';
    ptFloat.style.top = (rect.top + rect.height / 2) + 'px';
    document.body.appendChild(ptFloat);
    setTimeout(() => ptFloat.remove(), 1000);

    showToast('↩️ Tarea desmarcada');
  }

  // Apply state change (reuse existing helper)
  setTimeout(() => {
    _applyComplete(id, task, user, newDone);
    // Refresh only the chip visuals without re-rendering the whole accordion
    const uid = state.currentViewUser || state.myUserId;
    renderCalAccordion(uid, Object.entries(state.tasks), state.selectedCalDay);
  }, newDone ? 350 : 300);
};  
  
// ══════════════════════════════════════════════════════  
// MODAL DAY PICKER  
// ══════════════════════════════════════════════════════  
function renderDayPicker(selectedDays) {  
  const dp = document.getElementById('dayPicker');  
  dp.innerHTML = DAY_NAMES.map((name, i) => `  
    <div class="day-btn ${selectedDays.includes(i)?'sel':''}" onclick="toggleDay(${i},this)">  
      <div class="day-letter">${name}</div>  
      <div class="day-dot"></div>  
    </div>  
  `).join('');  
}  
  
window.toggleDay = function(i, el) {  
  const idx = state.selectedDays.indexOf(i);  
  if (idx >= 0) state.selectedDays.splice(idx, 1);  
  else state.selectedDays.push(i);  
  el.classList.toggle('sel', state.selectedDays.includes(i));  
};  
  
window.onFreqChange = function(val) {  
  const wrap = document.getElementById('dayPickerWrap');  
  if (val === 'Diaria') {  
    state.selectedDays = [0,1,2,3,4,5,6];  
    wrap.style.display = 'block';  
    renderDayPicker(state.selectedDays);  
  } else if (val === 'Semanal') {  
    if (!state.selectedDays.length) state.selectedDays = [1];  
    wrap.style.display = 'block';  
    renderDayPicker(state.selectedDays);  
  } else {  
    wrap.style.display = 'none';  
  }  
};  
  
// ══════════════════════════════════════════════════════  
function triggerBurst(e) {  
  const c = document.getElementById('burstContainer');  
  const x = e?.clientX || window.innerWidth / 2;  
  const y = e?.clientY || window.innerHeight / 2;  
  const colors = ['#7DF9FF','#34EE9A','#A78BFA','#FFC453','#FF6B8A','#60A5FA'];  
  
  // Ring expand  
  const ring = document.createElement('div');  
  ring.style.cssText = `  
    position:absolute; left:${x}px; top:${y}px;  
    width:10px; height:10px; border-radius:50%;  
    border:3px solid rgba(52,238,154,0.8);  
    transform:translate(-50%,-50%) scale(0);  
    animation:ringExpand 0.6s cubic-bezier(0.16,1,0.3,1) forwards;  
    pointer-events:none;  
  `;  
  c.appendChild(ring);  
  setTimeout(() => ring.remove(), 700);  
  
  // Particles  
  for (let i = 0; i < 24; i++) {  
    const p = document.createElement('div');  
    const size = 5 + Math.random() * 7;  
    const angle = (Math.PI * 2 / 24) * i + (Math.random() - 0.5) * 0.4;  
    const dist = 50 + Math.random() * 90;  
    const tx = Math.cos(angle) * dist;  
    const ty = Math.sin(angle) * dist;  
    const isStreak = Math.random() > 0.6;  
    p.className = 'burst-particle';  
    p.style.cssText = `  
      left:${x}px; top:${y}px;  
      width:${isStreak ? size * 0.5 : size}px;  
      height:${isStreak ? size * 3 : size}px;  
      border-radius:${isStreak ? '2px' : '50%'};  
      background:${colors[i % colors.length]};  
      --tx:translate(${tx}px,${ty}px);  
      transform-origin:center;  
      transform:translate(-50%,-50%) rotate(${angle}rad);  
      animation-delay:${Math.random() * 0.08}s;  
      animation-duration:${0.55 + Math.random() * 0.35}s;  
      box-shadow:0 0 ${isStreak ? 4 : 6}px ${colors[i % colors.length]};  
    `;  
    c.appendChild(p);  
    setTimeout(() => p.remove(), 1000);  
  }  
}  
  
// Inject ring keyframe once  
if (!document.getElementById('ringKeyframe')) {  
  const s = document.createElement('style');  
  s.id = 'ringKeyframe';  
  s.textContent = `@keyframes ringExpand {  
    0%   { transform:translate(-50%,-50%) scale(0); opacity:1; }  
    60%  { opacity:0.6; }  
    100% { transform:translate(-50%,-50%) scale(8); opacity:0; }  
  }`;  
  document.head.appendChild(s);  
}  
  
// ══════════════════════════════════════════════════════  
// TOAST  
// ══════════════════════════════════════════════════════  
let toastTimer;  
window.showToast = function(msg) {  
  const t = document.getElementById('toast');  
  t.textContent = msg;  
  t.classList.add('show');  
  clearTimeout(toastTimer);  
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);  
};  
  
// ══════════════════════════════════════════════════════  
// UTILS  
// ══════════════════════════════════════════════════════  
function relTime(ts) {  
  const diff = Math.floor((Date.now() - ts) / 60000);  
  if (diff < 1) return 'Ahora mismo';  
  if (diff < 60) return `Hace ${diff} min`;  
  if (diff < 1440) return `Hace ${Math.floor(diff/60)}h`;  
  return new Date(ts).toLocaleDateString('es-ES', { day:'numeric', month:'short' });  
}  
  
// ══════════════════════════════════════════════════════  
// LOCAL PERSISTENCE HELPER  
// ══════════════════════════════════════════════════════  
function persistLocalHome() {
  if (!state.useLocalMode || !state.homeId) return;
  const homes = JSON.parse(localStorage.getItem('hogar_homes') || '{}');
  if (!homes[state.homeId]) homes[state.homeId] = {};
  homes[state.homeId].users = state.users;
  homes[state.homeId].tasks = state.tasks;
  homes[state.homeId].ownerId = state.ownerId;
  homes[state.homeId].name = state.homeName;
  homes[state.homeId].code = state.homeCode;
  localStorage.setItem('hogar_homes', JSON.stringify(homes));
}

// ══════════════════════════════════════════════════════  
// PWA INSTALL  
// ══════════════════════════════════════════════════════  
let deferredPrompt;  
function setupPWA() {  
  window.addEventListener('beforeinstallprompt', e => {  
    e.preventDefault();  
    deferredPrompt = e;  
    const banner = document.getElementById('installBanner');  
    if (banner) banner.style.display = 'flex';  
  });  
  
  const btn = document.getElementById('installBtn');  
  if (btn) btn.addEventListener('click', async () => {  
    if (!deferredPrompt) {  
      // iOS instructions  
      showToast('En Safari: Compartir → Añadir a pantalla de inicio');  
      return;  
    }  
    deferredPrompt.prompt();  
    const result = await deferredPrompt.userChoice;  
    deferredPrompt = null;  
    document.getElementById('installBanner').style.display = 'none';  
  });  
  
  // iOS detection  
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);  
  const isStandalone = window.navigator.standalone;  
  if (isIOS && !isStandalone) {  
    const banner = document.getElementById('installBanner');  
    if (banner) {  
      banner.style.display = 'flex';  
      banner.querySelector('.install-btn').textContent = 'Cómo';  
      banner.querySelector('.install-btn').onclick = () => {  
        showToast('Toca Compartir 📤 → "Añadir a inicio"');  
      };  
    }  
  }  
}  
  
// Avatar pickers  
window.selectAv = function(av, gridId, el) {  
  state.selectedAvatar = av;  
  document.querySelectorAll(`#${gridId} .avatar-opt`).forEach(e => e.classList.remove('sel'));  
  el.classList.add('sel');  
};  
  
window.authGo = authGo;  
window.authBack = authBack;  
window.createHome = createHome;  
window.joinHome = joinHome;
window.loginUser = loginUser;
window.enterApp = enterApp;  
window.logout = logout;  
  
// Render avatar pickers  
function renderAvatarPickers() {  
  ['avatarPick','avatarPickJoin'].forEach(id => {  
    const el = document.getElementById(id);  
    if (!el) return;  
    el.innerHTML = AVATARS.map((a,i) => `  
      <div class="avatar-opt ${i===0?'sel':''}" onclick="selectAv('${a}','${id}',this)">${a}</div>  
    `).join('');  
  });  
  state.selectedAvatar = AVATARS[0];  
}  
renderAvatarPickers();  
</script>  
  
</body>  
</html>  
